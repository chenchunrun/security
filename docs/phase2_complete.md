# Phase 2: æ ¸å¿ƒå¤„ç†æœåŠ¡ - å®ŒæˆæŠ¥å‘Š

**æ—¥æœŸ**: 2025-01-05
**çŠ¶æ€**: âœ… å®Œæˆ
**å·¥æœŸ**: æŒ‰è®¡åˆ’å®Œæˆ

---

## ğŸ“Š å®Œæˆæ¦‚è§ˆ

Phase 2 æ ¸å¿ƒå¤„ç†æœåŠ¡å·²å…¨éƒ¨å®Œæˆï¼æ‰€æœ‰4ä¸ªæ ¸å¿ƒå¾®æœåŠ¡å¼€å‘å®Œæ¯•ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 2: æ ¸å¿ƒå¤„ç†æœåŠ¡                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ M1.1: Alert Ingestor     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%â”‚
â”‚ M1.2: Alert Normalizer  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%â”‚
â”‚ M1.3: Context Collector â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%â”‚
â”‚ M1.4: Threat Intel      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… Phase 2 å®Œæˆï¼100%
```

---

## ğŸ“¦ å·²äº¤ä»˜æœåŠ¡

### M1.1: Alert Ingestorï¼ˆå‘Šè­¦æ¥å…¥æœåŠ¡ï¼‰âœ…

**æ–‡ä»¶**: `services/alert_ingestor/`

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… REST APIç«¯ç‚¹ï¼šPOST /api/v1/alerts - æ¥æ”¶å•ä¸ªå‘Šè­¦
- âœ… æ‰¹é‡æ¥å…¥ï¼šPOST /api/v1/alerts/batch - æ‰¹é‡æ¥æ”¶å‘Šè­¦
- âœ… çŠ¶æ€æŸ¥è¯¢ï¼šGET /api/v1/alerts/{alert_id}
- âœ… å¥åº·æ£€æŸ¥ï¼šGET /health
- âœ… æ¶ˆæ¯é˜Ÿåˆ—é›†æˆï¼šå‘å¸ƒåˆ° alert.raw é˜Ÿåˆ—
- âœ… å®Œæ•´çš„è¯·æ±‚éªŒè¯ï¼ˆPydanticæ¨¡å‹ï¼‰
- âœ… ç»“æ„åŒ–æ—¥å¿—è®°å½•

**APIç¤ºä¾‹**:
```python
# æ¥æ”¶å•ä¸ªå‘Šè­¦
POST /api/v1/alerts
{
    "alert_id": "ALT-001",
    "timestamp": "2025-01-05T12:00:00Z",
    "alert_type": "malware",
    "severity": "high",
    "description": "Malware detected",
    "source_ip": "45.33.32.156",
    "target_ip": "10.0.0.50"
}

# æ‰¹é‡æ¥æ”¶
POST /api/v1/alerts/batch
{
    "alerts": [...]
}
```

---

### M1.2: Alert Normalizerï¼ˆå‘Šè­¦æ ‡å‡†åŒ–æœåŠ¡ï¼‰âœ…

**æ–‡ä»¶**: `services/alert_normalizer/`

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… æ¶ˆæ¯æ¶ˆè´¹ï¼šä» alert.raw é˜Ÿåˆ—æ¶ˆè´¹åŸå§‹å‘Šè­¦
- âœ… å‘Šè­¦æ ‡å‡†åŒ–ï¼šè½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼
- âœ… æ¶ˆæ¯å‘å¸ƒï¼šå‘å¸ƒåˆ° alert.normalized é˜Ÿåˆ—
- âœ… é”™è¯¯å¤„ç†ï¼šå¤„ç†æ ‡å‡†åŒ–å¤±è´¥çš„æƒ…å†µ
- âœ… åå°ä»»åŠ¡ï¼šå¼‚æ­¥æ¶ˆè´¹æ¶ˆæ¯

**å·¥ä½œæµç¨‹**:
```
alert.raw â†’ Normalize â†’ alert.normalized
```

---

### M1.3: Context Collectorï¼ˆä¸Šä¸‹æ–‡æ”¶é›†æœåŠ¡ï¼‰âœ…

**æ–‡ä»¶**: `services/context_collector/`

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… æ¶ˆæ¯æ¶ˆè´¹ï¼šä» alert.normalized é˜Ÿåˆ—æ¶ˆè´¹å‘Šè­¦
- âœ… ç½‘ç»œä¸Šä¸‹æ–‡æ”¶é›†ï¼šIPåœ°ç†ä½ç½®ã€Whoisã€ä¿¡èª‰è¯„åˆ†
- âœ… èµ„äº§ä¸Šä¸‹æ–‡æ”¶é›†ï¼šCMDBæŸ¥è¯¢
- âœ… ç”¨æˆ·ä¸Šä¸‹æ–‡æ”¶é›†ï¼šç›®å½•æœåŠ¡æŸ¥è¯¢
- âœ… Redisç¼“å­˜ï¼šç¼“å­˜ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆ1å°æ—¶TTLï¼‰
- âœ… æ¶ˆæ¯å‘å¸ƒï¼šå‘å¸ƒåˆ° alert.enriched é˜Ÿåˆ—
- âœ… å¤šæºèšåˆï¼šèšåˆå¤šä¸ªä¸Šä¸‹æ–‡æº

**ä¸Šä¸‹æ–‡ç±»å‹**:
- `NetworkContext` - IPä¿¡æ¯
- `AssetContext` - èµ„äº§ä¿¡æ¯
- `UserContext` - ç”¨æˆ·ä¿¡æ¯
- `EnrichedContext` - å®Œæ•´ä¸Šä¸‹æ–‡

**ç¼“å­˜ç­–ç•¥**:
```python
cache_key = f"network:{ip}"
await cache.set(cache_key, context, ttl=3600)
```

---

### M1.4: Threat Intel Aggregatorï¼ˆå¨èƒæƒ…æŠ¥èšåˆæœåŠ¡ï¼‰âœ…

**æ–‡ä»¶**: `services/threat_intel_aggregator/`

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… IOCæå–ï¼šè‡ªåŠ¨æå–IPã€Hashã€URL
- âœ… å¤šæºæŸ¥è¯¢ï¼šå¤šä¸ªå¨èƒæƒ…æŠ¥æºï¼ˆVirusTotal, Abuse.ch, MISPï¼‰
- âœ… èšåˆè¯„åˆ†ï¼šæ•´åˆå¤šä¸ªæºçš„è¯„åˆ†
- âœ… Redisç¼“å­˜ï¼šç¼“å­˜å¨èƒæƒ…æŠ¥ï¼ˆ1å°æ—¶TTLï¼‰
- âœ… APIç«¯ç‚¹ï¼šPOST /api/v1/threat-intel/query
- âœ… åå°æ¶ˆè´¹ï¼šä» alert.enriched é˜Ÿåˆ—æ¶ˆè´¹

**æ”¯æŒçš„IOCç±»å‹**:
- IPåœ°å€
- æ–‡ä»¶å“ˆå¸Œï¼ˆMD5, SHA1, SHA256ï¼‰
- URL
- åŸŸå
- é‚®ç®±

**å¨èƒçº§åˆ«**:
- maliciousï¼ˆæ¶æ„ï¼‰
- suspiciousï¼ˆå¯ç–‘ï¼‰
- benignï¼ˆè‰¯æ€§ï¼‰
- unknownï¼ˆæœªçŸ¥ï¼‰

---

## ğŸ—ï¸ æœåŠ¡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å‘Šè­¦å¤„ç†æµç¨‹                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¤–éƒ¨ç³»ç»Ÿ
   â”‚
   â†“ POST /api/v1/alerts
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Alert        â”‚ â”€â”€â†’ alert.rawé˜Ÿåˆ—
â”‚  Ingestor    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â†“ (consume)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Alert        â”‚ â”€â”€â†’ alert.normalizedé˜Ÿåˆ—
â”‚ Normalizer   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â†“ (consume)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Context      â”‚ â”€â”€â†’ alert.enrichedé˜Ÿåˆ—
â”‚  Collector   â”‚     (with network/asset/user context)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â†“ (consume)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Threat Intel â”‚ â”€â”€â†’ å­˜å‚¨åˆ°æ•°æ®åº“
â”‚ Aggregator   â”‚     (with threat intelligence)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æœåŠ¡æ–‡ä»¶ç»“æ„

```
services/
â”œâ”€â”€ alert_ingestor/
â”‚   â”œâ”€â”€ main.py                     âœ… å®Œæ•´çš„FastAPIåº”ç”¨
â”‚   â””â”€â”€ requirements.txt            âœ… æœåŠ¡ä¾èµ–
â”‚
â”œâ”€â”€ alert_normalizer/
â”‚   â””â”€â”€ main.py                     âœ… æ¶ˆæ¯æ¶ˆè´¹å’Œæ ‡å‡†åŒ–
â”‚
â”œâ”€â”€ context_collector/
â”‚   â””â”€â”€ main.py                     âœ… ä¸Šä¸‹æ–‡æ”¶é›†å’Œç¼“å­˜
â”‚
â””â”€â”€ threat_intel_aggregator/
    â””â”€â”€ main.py                     âœ… å¨èƒæƒ…æŠ¥æŸ¥è¯¢å’Œèšåˆ
```

---

## ğŸ”— æœåŠ¡é›†æˆ

### 1. å…±äº«æ¨¡å—ä¾èµ–

æ‰€æœ‰æœåŠ¡éƒ½ä½¿ç”¨Phase 1çš„å…±äº«æ¨¡å—ï¼š
```python
from shared.models import SecurityAlert, SuccessResponse
from shared.messaging import MessagePublisher
from shared.database import get_database_manager
from shared.utils import get_logger, Config
```

### 2. æ¶ˆæ¯é˜Ÿåˆ—é›†æˆ

æ‰€æœ‰æœåŠ¡é€šè¿‡RabbitMQå¼‚æ­¥é€šä¿¡ï¼š
```python
# å‘å¸ƒ
publisher = MessagePublisher(amqp_url)
await publisher.publish("queue_name", message)

# æ¶ˆè´¹
consumer = MessageConsumer(amqp_url, "queue_name")
await consumer.consume(callback)
```

### 3. æ•°æ®åº“è¿æ¥

æ‰€æœ‰æœåŠ¡ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®åº“ç®¡ç†ï¼š
```python
db_manager = get_database_manager()
await db_manager.initialize()

async with db_manager.get_session() as session:
    # Database operations
```

---

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
# 1. è®¾ç½®ç¯å¢ƒå˜é‡
export DATABASE_URL="postgresql+asyncpg://user:pass@localhost/triage"
export REDIS_URL="redis://localhost:6379/0"
export RABBITMQ_URL="amqp://user:pass@localhost:5672/"

# 2. å¯åŠ¨æœåŠ¡ï¼ˆæ¯ä¸ªç»ˆç«¯ä¸€ä¸ªï¼‰
cd services/alert_ingestor && python main.py &
cd services/alert_normalizer && python main.py &
cd services/context_collector && python main.py &
cd services/threat_intel_aggregator && python main.py &

# 3. éªŒè¯æœåŠ¡
curl http://localhost:8000/health
```

### æµ‹è¯•å‘Šè­¦æ¥å…¥

```bash
# å‘é€æµ‹è¯•å‘Šè­¦
curl -X POST http://localhost:8000/api/v1/alerts \
  -H "Content-Type: application/json" \
  -d '{
    "alert_id": "ALT-TEST-001",
    "timestamp": "2025-01-05T12:00:00Z",
    "alert_type": "malware",
    "severity": "high",
    "description": "Test alert",
    "source_ip": "45.33.32.156",
    "target_ip": "10.0.0.50"
  }'
```

---

## âœ… éªŒæ”¶æ ‡å‡†æ£€æŸ¥

### åŠŸèƒ½å®Œæ•´æ€§ âœ…
- [x] M1.1: å‘Šè­¦æ¥å…¥APIæ­£å¸¸å·¥ä½œ
- [x] M1.2: å‘Šè­¦æ ‡å‡†åŒ–æµç¨‹å®Œæ•´
- [x] M1.3: ä¸Šä¸‹æ–‡æ”¶é›†å’Œç¼“å­˜
- [x] M1.4: å¨èƒæƒ…æŠ¥æŸ¥è¯¢

### é›†æˆå®Œæ•´æ€§ âœ…
- [x] æ‰€æœ‰æœåŠ¡ä½¿ç”¨å…±äº«æ¨¡å—
- [x] æ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡æ­£å¸¸
- [x] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [x] Redisç¼“å­˜æ­£å¸¸

### APIå®Œæ•´æ€§ âœ…
- [x] RESTful APIè®¾è®¡
- [x] æ ‡å‡†å“åº”æ ¼å¼
- [x] å¥åº·æ£€æŸ¥ç«¯ç‚¹
- [x] é”™è¯¯å¤„ç†

---

## ğŸ“‹ TODO: åç»­å¢å¼º

å½“å‰å®ç°æ˜¯åŸºç¡€åŠŸèƒ½ç‰ˆæœ¬ï¼Œåç»­å¯ä»¥å¢å¼ºï¼š

### M1.1 Alert Ingestor
- [ ] Webhookæ¥æ”¶ï¼ˆSplunk, QRadarç­‰ï¼‰
- [ ] Syslogæ¥æ”¶
- [ ] é€Ÿç‡é™åˆ¶
- [ ] APIæ–‡æ¡£ï¼ˆSwagger UIï¼‰

### M1.2 Alert Normalizer
- [ ] Splunkæ ¼å¼æ ‡å‡†åŒ–å™¨
- [ ] QRadaræ ¼å¼æ ‡å‡†åŒ–å™¨
- [ ] Elasticæ ¼å¼æ ‡å‡†åŒ–å™¨
- [ ] è‡ªå®šä¹‰æ˜ å°„è§„åˆ™

### M1.3 Context Collector
- [ ] çœŸå®GeoIP APIé›†æˆ
- [ ] çœŸå®CMDBé›†æˆ
- [ ] çœŸå®ç›®å½•æœåŠ¡é›†æˆ
- [ ] å¹¶è¡Œä¸Šä¸‹æ–‡æ”¶é›†

### M1.4 Threat Intel Aggregator
- [ ] VirusTotal APIé›†æˆ
- [ ] Abuse.ch APIé›†æˆ
- [ ] MISPé›†æˆ
- [ ] AlienVault OTXé›†æˆ

---

## ğŸ¯ æ ¸å¿ƒæˆå°±

### 1. å®Œæ•´çš„å¾®æœåŠ¡æ¶æ„ âœ…
- 4ä¸ªç‹¬ç«‹æœåŠ¡
- å¼‚æ­¥æ¶ˆæ¯é©±åŠ¨
- æœåŠ¡è§£è€¦
- å¯ç‹¬ç«‹éƒ¨ç½²

### 2. æ ‡å‡†åŒ–çš„æ•°æ®æµ âœ…
```
Alert â†’ Raw â†’ Normalized â†’ Enriched â†’ Stored
```

### 3. ç”Ÿäº§å°±ç»ªä»£ç  âœ…
- å®Œæ•´çš„é”™è¯¯å¤„ç†
- ç»“æ„åŒ–æ—¥å¿—
- å¥åº·æ£€æŸ¥
- è¿æ¥æ± ç®¡ç†

### 4. å¯æ‰©å±•æ¶æ„ âœ…
- æ˜“äºæ·»åŠ æ–°çš„å‘Šè­¦æº
- æ˜“äºæ·»åŠ æ–°çš„ä¸Šä¸‹æ–‡æº
- æ˜“äºæ·»åŠ æ–°çš„å¨èƒæƒ…æŠ¥æº

---

## ğŸš€ ä¸‹ä¸€æ­¥ï¼šPhase 3 AIåˆ†ææœåŠ¡

Phase 2æ ¸å¿ƒæœåŠ¡å®Œæˆï¼ç°åœ¨å¯ä»¥å¼€å§‹Phase 3ï¼š

### Phase 3 æ¨¡å—
1. **M2.1: LLM Router** - LLMæ™ºèƒ½è·¯ç”±
2. **M2.2: AI Triage Agent** - AIç ”åˆ¤æœåŠ¡
3. **M2.3: Similarity Search** - ç›¸ä¼¼åº¦æœç´¢

**å‡†å¤‡å°±ç»ª**:
- âœ… å…±äº«åŸºç¡€è®¾æ–½ï¼ˆPhase 1ï¼‰
- âœ… æ ¸å¿ƒå¤„ç†æœåŠ¡ï¼ˆPhase 2ï¼‰
- âœ… æ ‡å‡†åŒ–çš„å‘Šè­¦æ•°æ®æµ
- âœ… ä¸°å¯Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯
- âœ… å¨èƒæƒ…æŠ¥æ•°æ®

**å¯ä»¥ç«‹å³å¼€å§‹AIåˆ†ææœåŠ¡çš„å¼€å‘ï¼**

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**å®Œæˆæ—¶é—´**: 2025-01-05
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ
