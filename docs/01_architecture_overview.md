# 生产级安全告警研判系统 - 架构总览

**版本**: v1.0
**日期**: 2025-01-05
**状态**: 架构设计阶段

---

## 📋 目录

- [1. 系统概述](#1-系统概述)
- [2. 架构设计原则](#2-架构设计原则)
- [3. 整体架构图](#3-整体架构图)
- [4. 技术栈选型](#4-技术栈选型)
- [5. 核心设计决策](#5-核心设计决策)
- [6. 非功能性需求](#6-非功能性需求)

---

## 1. 系统概述

### 1.1 项目背景

基于现有原型系统的深度分析，构建一个**生产级、可扩展、高可用**的智能安全告警研判系统。系统采用AI驱动的多维度分析，实现告警自动化处理、智能风险评估和快速响应。

### 1.2 核心价值

```
┌─────────────────────────────────────────────────────────────────┐
│                     核心价值主张                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  🎯 提升效率                                                     │
│     • 告警研判自动化率: 70-80%                                    │
│     • 平均处理时间: 从30分钟降至3秒                               │
│     • 误报率降低: 50%+                                           │
│                                                                  │
│  🛡️ 增强安全                                                     │
│     • 7x24小时实时监控                                           │
│     • 高危告警响应时间: < 1分钟                                   │
│     • 相似攻击识别率: 85%+                                       │
│                                                                  │
│  💰 降低成本                                                     │
│     • 人力成本节约: 2-3人/班次                                    │
│     • 使用公司私有化MaaS，API成本忽略                             │
│     • 基础设施成本可控                                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.3 系统边界

**接入范围**:
- SIEM系统告警 (Splunk, ELK, QRadar等)
- 网络安全设备 (防火墙, IDS/IPS, WAF)
- 端点防护 (EDR, 杀毒软件)
- 应用安全 (WAF, RASP)
- 第三方API (Webhook)

**不包含范围**:
- 日志采集和存储 (已有SIEM处理)
- 原始安全设备管理
- 物理安全告警

---

## 2. 架构设计原则

### 2.1 核心原则

```
┌────────────────────────────────────────────────────────────────────┐
│                        架构设计原则                                 │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  1. 分层解耦 (Layered Decoupling)                                  │
│     • 清晰的层次划分                                               │
│     • 层间通过标准接口通信                                         │
│     • 独立部署和扩展                                               │
│                                                                    │
│  2. 异步驱动 (Asynchronous Driven)                                │
│     • 基于消息队列的异步处理                                       │
│     • 解耦服务和数据流                                             │
│     • 提升并发处理能力                                             │
│                                                                    │
│  3. 可观测性 (Observability)                                      │
│     • 全链路追踪                                                   │
│     • 结构化日志                                                   │
│     • 实时监控告警                                                 │
│                                                                    │
│  4. 故障隔离 (Failure Isolation)                                  │
│     • 单个服务故障不影响全局                                       │
│     • 熔断降级机制                                                 │
│     • 优雅降级                                                     │
│                                                                    │
│  5. 数据一致性 (Data Consistency)                                 │
│     • 最终一致性模型                                               │
│     • 幂等性设计                                                   │
│     • 事务性操作                                                   │
│                                                                    │
│  6. 安全优先 (Security First)                                     │
│     • 零信任网络                                                   │
│     • 最小权限原则                                                 │
│     • 数据加密传输和存储                                           │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

### 2.2 设计模式

- **CQRS**: 命令查询职责分离
- **Event Sourcing**: 事件溯源用于审计
- **Circuit Breaker**: 熔断器防止雪崩
- **Rate Limiting**: 速率限制保护服务
- **Bulkhead**: 舱壁隔离资源
- **Retry with Exponential Backoff**: 智能重试

---

## 3. 整体架构图

### 3.1 分层架构视图

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                   生产级安全告警研判系统 - 系统架构图                           ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│                          EXTERNAL LAYER (外部系统)                            │
│  SIEM / 防火墙 / IDS / EDR / 第三方API                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
╔══════════════════════════════════════════════════════════════════════════════╗
║                    GATEWAY & INGESTION LAYER (网关接入层)                      ║
║  Kong API Gateway → Alert Ingestor → Normalizer                              ║
╚══════════════════════════════════════════════════════════════════════════════╝
                                    │
                                    ▼
╔══════════════════════════════════════════════════════════════════════════════╗
║                    MESSAGE QUEUE LAYER (消息队列层)                            ║
║  RabbitMQ Cluster: alert.raw → alert.normalized → alert.result                ║
╚══════════════════════════════════════════════════════════════════════════════╝
                                    │
        ┌───────────────────────────┼───────────────────────────┐
        ▼                           ▼                           ▼
╔═════════════════════╗ ══════════════════════════════════════════════════════╗
║ ENRICHMENT SERVICES ║ AI ANALYSIS SERVICES      ║ WORKFLOW & AUTOMATION       ║
║  • Context Collector ║  • Triage Agent           ║  • Temporal Workflow      ║
║  • Threat Intel     ║  • Similarity Search       ║  • SOAR Playbooks         ║
║  • Asset Enricher   ║  • Attack Chain Analyzer   ║  • Notification Service   ║
╚═════════════════════╝ ══════════════════════════════════════════════════════╝
                                    │
                                    ▼
╔══════════════════════════════════════════════════════════════════════════════╗
║                    DATA LAYER (数据层)                                        ║
║  PostgreSQL / Redis / ChromaDB / Elasticsearch / MinIO                        ║
╚══════════════════════════════════════════════════════════════════════════════╝
                                    │
                                    ▼
╔══════════════════════════════════════════════════════════════════════════════╗
║                    API & UI LAYER (接口与展示层)                               ║
║  RESTful API (FastAPI) + Web UI (React)                                       ║
╚══════════════════════════════════════════════════════════════════════════════╝
                                    │
                                    ▼
╔══════════════════════════════════════════════════════════════════════════════╗
║                    MONITORING LAYER (监控运维层)                               ║
║  Prometheus / Grafana / Jaeger / ELK / Sentry                                 ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

### 3.2 核心数据流

```
┌──────────────┐
│ Security     │
│ Device       │
│      │       │
│      │ ① Alert via REST API
│      ▼       │
┌──────────────┐
│ API Gateway  │ ← Auth, Rate Limit, Validation
└──────────────┘
      │
      │ ② Forward
      ▼
┌──────────────┐
│  Alert       │
│ Ingestor     │
└──────────────┘
      │
      │ ③ Publish to alert.raw
      ▼
┌──────────────┐
│  RabbitMQ    │
└──────────────┘
      │
      │ ④ Consume
      ▼
┌──────────────┐
│  Normalizer  │ ← Map to standard schema
└──────────────┘
      │
      │ ⑤ Publish to alert.normalized
      ├───────────┬───────────┬───────────┐
      ▼           ▼           ▼           ▼
┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐
│Context  │ │Threat   │ │Asset    │ │Vector   │
│Collector│ │Intel    │ │Enricher │ │Search   │
└─────────┘ └─────────┘ └─────────┘ └─────────┘
      │           │           │           │
      └───────────┴───────────┴───────────┘
                      │
                      ▼
              ┌───────────────┐
              │ AI Triage     │
              │ Agent         │
              │ (LangChain)   │
              └───────────────┘
                      │
                      ▼
              ┌───────────────┐
              │ Decision      │
              │ Engine        │
              └───────────────┘
                      │
      ┌───────────────┼───────────────┐
      ▼               ▼               ▼
┌──────────┐  ┌──────────┐  ┌──────────┐
│ Workflow │  │ SOAR     │  │ Notify   │
│ Engine   │  │ Playbook │  │ Service  │
└──────────┘  └──────────┘  └──────────┘
                      │
                      ▼
              ┌───────────────┐
              │  PostgreSQL   │
              └───────────────┘
                      │
                      ▼
              ┌───────────────┐
              │  Web UI /     │
              │  API Response │
              └───────────────┘
```

---

## 4. 技术栈选型

### 4.1 后端技术栈

| 技术 | 版本 | 用途 | 选型理由 |
|------|------|------|----------|
| **Python** | 3.11+ | 主要开发语言 | AI/ML生态丰富 |
| **FastAPI** | Latest | API服务框架 | 高性能异步、自动文档 |
| **LangChain** | Latest | AI编排框架 | LLM应用标准 |
| **Pydantic** | v2 | 数据验证 | 类型安全 |
| **Temporal** | Latest | 工作流引擎 | 持久化、可观测 |
| **SQLAlchemy** | 2.0 | ORM | 成熟稳定 |

### 4.2 LLM服务（公司私有化MaaS）

```
┌────────────────────────────────────────────────────────────────────┐
│                  私有化MaaS服务配置                                 │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  🤖 DeepSeek-V3                                                     │
│     • 用途: 复杂推理、深度分析                                      │
│     • 优势: 逻辑推理能力强                                          │
│     • 部署: 内网MaaS平台                                            │
│     • 调用方式: http://internal-maas.deepseek/v1                    │
│                                                                    │
│  🤖 Qwen3 (通义千问3)                                               │
│     • 用途: 通用分析、快速响应                                       │
│     • 优势: 中文理解、速度快                                         │
│     • 部署: 内网MaaS平台                                            │
│     • 调用方式: http://internal-maas.qwen/v1                         │
│                                                                    │
│  🔄 智能路由策略                                                     │
│     • 简单告警 → Qwen3 (快速、低成本)                                │
│     • 复杂分析 → DeepSeek-V3 (深度推理)                              │
│     • 失败自动切换                                                    │
│     • 负载均衡                                                       │
│                                                                    │
│  💰 成本优势                                                         │
│     • 私有化部署，无外部API调用成本                                   │
│     • 可扩展性强，不受限流影响                                       │
│     • 数据安全可控                                                   │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

### 4.3 数据存储技术栈

| 技术 | 版本 | 用途 | 规模配置 |
|------|------|------|----------|
| **PostgreSQL** | 15+ | 主数据库 | 3节点Patroni HA |
| **Redis** | 7+ | 缓存 | 6节点Cluster |
| **RabbitMQ** | 3.12 | 消息队列 | 3节点集群 |
| **ChromaDB** | Latest | 向量数据库 | 2节点 + pgvector |
| **Elasticsearch** | 8.x | 日志检索 | 3节点集群 |
| **TimescaleDB** | Latest | 时序数据 | 2节点 |
| **MinIO** | Latest | 对象存储 | 4节点分布式 |

### 4.4 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **React** | 18.x | UI框架 |
| **TypeScript** | 5.x | 类型安全 |
| **Tailwind CSS** | 3.x | 样式框架 |
| **Recharts** | Latest | 数据可视化 |
| **TanStack Query** | Latest | 数据获取 |
| **Vite** | Latest | 构建工具 |

### 4.5 DevOps技术栈

| 技术 | 用途 |
|------|------|
| **Kubernetes** | 容器编排 |
| **Docker** | 容器化 |
| **Helm** | K8s包管理 |
| **ArgoCD** | GitOps部署 |
| **Prometheus** | 指标收集 |
| **Grafana** | 可视化 |
| **Jaeger** | 链路追踪 |
| **ELK Stack** | 日志聚合 |
| **Sentry** | 错误追踪 |

---

## 5. 核心设计决策

### 5.1 为什么选择FastAPI?

✅ **高性能**: 基于Starlette，性能可媲美NodeJS和Go
✅ **异步原生**: 完整支持async/await
✅ **自动文档**: OpenAPI/Swagger自动生成
✅ **类型安全**: Pydantic数据验证
✅ **现代Python**: 3.6+类型提示

### 5.2 为什么选择RabbitMQ而不是Kafka?

✅ **协议丰富**: AMQP, MQTT, STOMP
✅ **消息确认**: 可靠的消息传递
✅ **灵活性**: 支持多种消息模式
✅ **管理友好**: Web UI管理界面
✅ **适合规模**: 告警处理规模(10000+/天)足够

### 5.3 为什么选择ChromaDB而不是Milvus/Pinecone?

✅ **轻量级**: 部署简单，资源占用小
✅ **易集成**: Python原生支持
✅ **成本可控**: 开源免费，无外部依赖
✅ **性能足够**: 百万级向量检索性能良好
✅ **灵活存储**: 支持多种后端(包括PostgreSQL/pgvector)

### 5.4 为什么选择Temporal而不是Celery?

✅ **持久化**: 工作流状态持久化，重启可恢复
✅ **可观测**: 内置可视化工作流界面
✅ **复杂编排**: 支持复杂的长时间运行工作流
✅ **确定性**: 保证工作流执行的确定性
✅ **现代设计**: 云原生设计理念

### 5.5 为什么选择PostgreSQL而不是MongoDB?

✅ **ACID事务**: 强一致性保证
✅ **关系查询**: 复杂关联查询需求
✅ **JSON支持**: 原生JSONB类型
✅ **成熟稳定**: 企业级可靠性
✅ **扩展性**: 支持pgvector、TimescaleDB等扩展

---

## 6. 非功能性需求

### 6.1 性能指标

```
┌────────────────────────────────────────────────────────────────────┐
│  性能要求                                                          │
├────────────────────────────────────────────────────────────────────┤
│  • 告警处理延迟: P50 < 1s, P95 < 3s, P99 < 5s                      │
│  • 并发处理能力: 1000+ 告警/秒                                     │
│  • 历史查询响应: < 500ms (百万级数据)                              │
│  • 相似告警检索: < 1s                                              │
│  • API响应时间: < 200ms (非LLM调用)                                │
│  • 系统可用性: 99.9% (年停机时间 < 8.76小时)                       │
└────────────────────────────────────────────────────────────────────┘
```

### 6.2 可扩展性

```
┌────────────────────────────────────────────────────────────────────┐
│  扩展能力                                                          │
├────────────────────────────────────────────────────────────────────┤
│  水平扩展                                                          │
│    • 所有服务无状态设计                                            │
│    • K8s HPA自动扩缩容                                             │
│    • 支持从10到1000+告警/天的平滑扩展                              │
│                                                                    │
│  垂直扩展                                                          │
│    • 数据库读写分离                                                │
│    • 缓存分层设计                                                  │
│    • 向量数据库分片                                                │
│                                                                    │
│  功能扩展                                                          │
│    • 插件化告警源接入                                              │
│    • 可配置的威胁情报源                                            │
│    • 自定义工作流                                                  │
│    • 自定义AI模型                                                  │
└────────────────────────────────────────────────────────────────────┘
```

### 6.3 安全性

```
┌────────────────────────────────────────────────────────────────────┐
│  安全要求                                                          │
├────────────────────────────────────────────────────────────────────┤
│  数据传输                                                          │
│    • TLS 1.3加密                                                  │
│    • mTLS双向认证(内部服务)                                        │
│    • API密钥管理                                                  │
│                                                                    │
│  数据存储                                                          │
│    • 敏感字段AES-256加密                                          │
│    • 数据库访问审计                                                │
│    • 备份数据加密                                                 │
│                                                                    │
│  访问控制                                                          │
│    • RBAC权限模型                                                 │
│    • MFA双因素认证                                                 │
│    • 最小权限原则                                                 │
│    • 定期权限审查                                                 │
│                                                                    │
│  审计合规                                                          │
│    • 完整操作日志                                                 │
│    • 日志不可篡改                                                 │
│    • 数据保留策略                                                 │
│    • 合规报表生成                                                 │
└────────────────────────────────────────────────────────────────────┘
```

### 6.4 可维护性

```
┌────────────────────────────────────────────────────────────────────┐
│  运维要求                                                          │
├────────────────────────────────────────────────────────────────────┤
│  监控告警                                                          │
│    • 全链路监控                                                    │
│    • 实时告警通知                                                 │
│    • 性能趋势分析                                                 │
│    • 容量规划                                                     │
│                                                                    │
│  日志管理                                                          │
│    • 结构化日志                                                    │
│    • 集中日志收集                                                 │
│    • 日志检索分析                                                 │
│    • 日志归档                                                     │
│                                                                    │
│  故障恢复                                                          │
│    • 自动故障转移                                                 │
│    • 数据备份恢复                                                 │
│    • 灾难恢复计划                                                 │
│    • 演练和测试                                                   │
│                                                                    │
│  部署运维                                                          │
│    • 蓝绿部署                                                     │
│    • 金丝雀发布                                                   │
│    • 零停机升级                                                   │
│    • 一键回滚                                                     │
└────────────────────────────────────────────────────────────────────┘
```

---

## 7. 架构演进路线

### 7.1 第一阶段：MVP (Q1 2025)

```
核心能力:
✓ 告警接入和标准化
✓ 基础AI研判(Qwen3)
✓ 威胁情报集成(2-3个源)
✓ 简单Web UI
✓ 基础监控

规模: 100告警/天
部署: 单节点
```

### 7.2 第二阶段：生产版 (Q2 2025)

```
增强能力:
✓ 高可用部署
✓ 工作流引擎
✓ 向量相似检索
✓ 自动响应(SOAR)
✓ 多渠道通知
✓ 用户权限管理

规模: 1000告警/天
部署: K8s集群
```

### 7.3 第三阶段：企业版 (Q3 2025)

```
企业能力:
✓ 高级分析(攻击链、MITRE)
✓ BI报表
✓ 审计合规
✓ SSO/LDAP集成
✓ 多租户支持
✓ 灰度发布

规模: 10000+告警/天
部署: 多集群
```

### 7.4 第四阶段：智能版 (Q4 2025+)

```
智能能力:
✓ 自定义模型微调
✓ 预测性分析
✓ 自动化编排增强
✓ 跨租户威胁情报共享
✓ AIOps

规模: 100000+告警/天
部署: 多地域分布式
```

---

**文档版本**: v1.0
**最后更新**: 2025-01-05
**下一步**: 查看[功能清单文档](./02_functional_requirements.md)
