# Copyright 2026 CCR <chenchunrun@gmail.com>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-config
  namespace: security-triage
data:
  REDIS_PORT: "6379"
  REDIS_CLUSTER_ENABLED: "yes"
  REDIS_CLUSTER_REPLICAS: "1"
---
apiVersion: v1
kind: Secret
metadata:
  name: redis-secrets
  namespace: security-triage
type: Opaque
stringData:
  REDIS_PASSWORD: "CHANGE_ME_STRONG_REDIS_PASSWORD"
---
# Redis Cluster StatefulSet (6 nodes: 3 masters + 3 replicas)
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis-cluster
  namespace: security-triage
spec:
  serviceName: redis-cluster
  replicas: 6
  selector:
    matchLabels:
      app: redis-cluster
  template:
    metadata:
      labels:
        app: redis-cluster
    spec:
      securityContext:
        fsGroup: 999
      initContainers:
      - name: init-sysctl
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          sysctl -w net.core.somaxconn=1024
          sysctl -w vm.overcommit_memory=1
          echo never > /proc/sys/vm/overcommit_memory
        securityContext:
          privileged: true
      containers:
      - name: redis
        image: redis:7-alpine
        ports:
        - name: redis
          containerPort: 6379
        - name: cluster-bus
          containerPort: 16379
        command:
        - sh
        - -c
        - |
          # Determine if this node is a master or replica based on ordinal
          ORDINAL=${HOSTNAME##*-}
          if [ $ORDINAL -lt 3 ]; then
            # First 3 nodes are masters
            redis-server --port 6379 --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes --appendfilename "appendonly-${ORDINAL}.aof" --dbfilename dump-${ORDINAL}.rdb --cluster-file-config-dir /data --requirepass "$REDIS_PASSWORD" --masterauth "$REDIS_PASSWORD"
          else
            # Last 3 nodes are replicas
            redis-server --port 6379 --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes --appendfilename "appendonly-${ORDINAL}.aof" --dbfilename dump-${ORDINAL}.rdb" --cluster-file-config-dir /data --requirepass "$REDIS_PASSWORD" --masterauth "$REDIS_PASSWORD" --slaveof redis-cluster-$((ORDINAL-3)) 6379
          fi
        env:
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: redis-secrets
              key: REDIS_PASSWORD
        volumeMounts:
        - name: redis-data
          mountPath: /data
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - redis-cli -a "$REDIS_PASSWORD" ping
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - sh
            - -c
            - redis-cli -a "$REDIS_PASSWORD" ping
          initialDelaySeconds: 5
            periodSeconds: 5
      volumes:
      - name: redis-data
        emptyDir: {}
---
# Redis Cluster Service
apiVersion: v1
kind: Service
metadata:
  name: redis-cluster
  namespace: security-triage
  labels:
    app: redis-cluster
spec:
  type: ClusterIP
  clusterIP: None
  ports:
  - name: redis
    port: 6379
    targetPort: 6379
  - name: cluster-bus
    port: 16379
    targetPort: 16379
  selector:
    app: redis-cluster
---
# Redis Sentinel for automatic failover
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-sentinel
  namespace: security-triage
spec:
  replicas: 3
  selector:
    matchLabels:
      app: redis-sentinel
  template:
    metadata:
      labels:
        app: redis-sentinel
    spec:
      containers:
      - name: sentinel
        image: redis:7-alpine
        ports:
        - name: sentinel
          containerPort: 26379
        command:
        - redis-sentinel
        - /etc/redis/sentinel.conf
        env:
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: redis-secrets
              key: REDIS_PASSWORD
        volumeMounts:
        - name: config
          mountPath: /etc/redis
      volumes:
      - name: config
        configMap:
          name: sentinel-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sentinel-config
  namespace: security-triage
data:
  sentinel.conf: |
    port 26379
    sentinel monitor mymaster redis-cluster-0 6379 2
    sentinel auth-pass mymaster $REDIS_PASSWORD
    sentinel down-after-milliseconds mymaster 5000
    sentinel parallel-syncs mymaster 1
    sentinel failover-timeout mymaster 10000
    sentinel notification-script mymaster /var/redis/notify.sh
    sentinel client-reconfig-script mymaster /var/redis/reconfig.sh
---
# Sentinel Service
apiVersion: v1
kind: Service
metadata:
  name: redis-sentinel
  namespace: security-triage
  labels:
    app: redis-sentinel
spec:
  type: ClusterIP
  ports:
  - name: sentinel
    port: 26379
    targetPort: 26379
  selector:
    app: redis-sentinel
---
# Redis service for application (connects via Sentinel)
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: security-triage
spec:
  type: ClusterIP
  ports:
  - name: redis
    port: 6379
    targetPort: 6379
---
# PodDisruptionBudget for Redis Cluster
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: redis-cluster-pdb
  namespace: security-triage
spec:
  minAvailable: 4
  selector:
    matchLabels:
      app: redis-cluster
