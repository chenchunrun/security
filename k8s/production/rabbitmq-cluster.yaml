# Copyright 2026 CCR <chenchunrun@gmail.com>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: v1
kind: ConfigMap
metadata:
  name: rabbitmq-config
  namespace: security-triage
data:
  RABBITMQ_DEFAULT_USER: "admin"
  RABBITMQ_DEFAULT_PASS: "CHANGE_ME"
  RABBITMQ_DEFAULT_VHOST: "/"
  RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: "-rabbit log_levels [{connection,error},{default,warning}]"
---
apiVersion: v1
kind: Secret
metadata:
  name: rabbitmq-secrets
  namespace: security-triage
type: Opaque
stringData:
  RABBITMQ_ERLANG_COOKIE: "CHANGE_ME_RANDOM_COOKIE_32_CHARS"
---
# RabbitMQ Cluster StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: rabbitmq-ha
  namespace: security-triage
spec:
  serviceName: rabbitmq-ha
  replicas: 3
  selector:
    matchLabels:
      app: rabbitmq
  template:
    metadata:
      labels:
        app: rabbitmq
        component: message-queue
    spec:
      securityContext:
        fsGroup: 999
      initContainers:
      - name: setup-permissions
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          chown -R 999:999 /var/lib/rabbitmq
        volumeMounts:
        - name: rabbitmq-data
          mountPath: /var/lib/rabbitmq
      containers:
      - name: rabbitmq
        image: rabbitmq:3.12-management-alpine
        ports:
        - name: amqp
          containerPort: 5672
        - name: management
          containerPort: 15672
        - name: epmd
          containerPort: 4369
        - name: cluster
          containerPort: 25672
        env:
        - name: RABBITMQ_DEFAULT_USER
          valueFrom:
            configMapKeyRef:
              name: rabbitmq-config
              key: RABBITMQ_DEFAULT_USER
        - name: RABBITMQ_DEFAULT_PASS
          valueFrom:
            configMapKeyRef:
              name: rabbitmq-config
              key: RABBITMQ_DEFAULT_PASS
        - name: RABBITMQ_DEFAULT_VHOST
          valueFrom:
            configMapKeyRef:
              name: rabbitmq-config
              key: RABBITMQ_DEFAULT_VHOST
        - name: RABBITMQ_ERLANG_COOKIE
          valueFrom:
            secretKeyRef:
              name: rabbitmq-secrets
              key: RABBITMQ_ERLANG_COOKIE
        - name: RABBITMQ_NODENAME
          value: "rabbit@$(hostname -f)"
        - name: RABBITMQ_CLUSTER_PARTITION_HANDLING
          value: "autoheal"
        - name: RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS
          valueFrom:
            configMapKeyRef:
              name: rabbitmq-config
              key: RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS
        envFrom:
        - configMapRef:
            name: rabbitmq-config
        volumeMounts:
        - name: rabbitmq-data
          mountPath: /var/lib/rabbitmq
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        livenessProbe:
          exec:
            command:
            - rabbitmq-diagnostics
            - -q
            - ping
          initialDelaySeconds: 60
          periodSeconds: 60
          timeoutSeconds: 15
        readinessProbe:
          exec:
            command:
            - rabbitmq-diagnostics
            - -q
            - ping
          initialDelaySeconds: 20
          periodSeconds: 30
          timeoutSeconds: 10
        lifecycle:
          postStart:
            exec:
              command:
              - /bin/sh
              - -c
              - |
                # Cluster setup
                if [ $(hostname) = "rabbitmq-ha-0" ]; then
                  # First node - wait for others to join
                  sleep 30
                else
                  # Join cluster
                  rabbitmqctl stop_app
                  rabbitmqctl reset
                  rabbitmqctl join_cluster rabbit@rabbitmq-ha-0.rabbitmq-ha.security-triage.svc.cluster.local
                  rabbitmqctl start_app
                fi
      volumes:
      - name: rabbitmq-data
        persistentVolumeClaim:
          claimName: rabbitmq-data
---
# RabbitMQ Service (AMQP)
apiVersion: v1
kind: Service
metadata:
  name: rabbitmq-ha
  namespace: security-triage
  labels:
    app: rabbitmq
    component: message-queue
spec:
  type: ClusterIP
  ports:
  - name: amqp
    port: 5672
    targetPort: 5672
  - name: management
    port: 15672
    targetPort: 15672
  selector:
    app: rabbitmq
---
# Management UI Service
apiVersion: v1
kind: Service
metadata:
  name: rabbitmq-management
  namespace: security-triage
  labels:
    app: rabbitmq
    component: message-queue
spec:
  type: ClusterIP
  ports:
  - name: management
    port: 15672
    targetPort: 15672
  selector:
    app: rabbitmq
---
# PodDisruptionBudget for RabbitMQ
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: rabbitmq-pdb
  namespace: security-triage
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: rabbitmq
