# Copyright 2026 CCR <chenchunrun@gmail.com>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

version: '3.8'

services:
  # PostgreSQL 15 - Main Database
  postgres:
    image: postgres:15-alpine
    container_name: security-triage-postgres
    environment:
      POSTGRES_DB: security_triage
      POSTGRES_USER: triage_user
      POSTGRES_PASSWORD: ${DB_PASSWORD:-triage_password_change_me}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init_db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: pg_isready -U triage_user -d security_triage
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - security-triage-network
    restart: unless-stopped

  # Redis 7 - Cache and Session Store
  redis:
    image: redis:7-alpine
    container_name: security-triage-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis_password_change_me}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: redis-cli ping
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - security-triage-network
    restart: unless-stopped

  # RabbitMQ 3.12 - Message Queue
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: security-triage-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-rabbitmq_password_change_me}
      RABBITMQ_DEFAULT_VHOST: /
    ports:
      - "5672:5672"   # AMQP protocol
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - security-triage-network
    restart: unless-stopped

  # ChromaDB - Vector Database for Similarity Search
  chromadb:
    image: chromadb/chroma:latest
    container_name: security-triage-chromadb
    ports:
      - "8001:8000"
    volumes:
      - chroma_data:/chroma/chroma
    healthcheck:
      test: curl -f http://localhost:8000/api/v1/heartbeat || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - security-triage-network
    restart: unless-stopped

  # Prometheus - Metrics Collection
  prometheus:
    image: prom/prometheus:latest
    container_name: security-triage-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    healthcheck:
      test: wget -q --spider http://localhost:9090/-/healthy || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - security-triage-network
    restart: unless-stopped
    profiles:
      - monitoring

  # Grafana - Visualization Dashboard
  grafana:
    image: grafana/grafana:latest
    container_name: security-triage-grafana
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-grafana_password_change_me}
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_INSTALL_PLUGINS: ""
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    healthcheck:
      test: wget -q --spider http://localhost:3000/api/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - security-triage-network
    restart: unless-stopped
    profiles:
      - monitoring

  # Kong - API Gateway
  kong:
    image: kong/kong-gateway:3.5.0.0-alpine
    container_name: security-triage-kong
    environment:
      # Databaseless (Declarative Config) Mode
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/declarative/kong.yml
      # DNS Resolver
      KONG_DNS_RESOLVER: ${KONG_DNS_RESOLVER:-127.0.0.11}
      # Proxy Ports
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      # Admin API
      KONG_ADMIN_GUI_URL: http://localhost:8002
      # NGINX
      KONG_NGINX_WORKER_PROCESSES: "2"
      # Plugins
      KONG_PLUGINS: bundled,jwt,rate-limiting,acl,key-auth,prometheus,cors,request-size-limiting,request-transformer,response-transformer,file-log
      KONG_PLUGINSERVER_NAMES: ""
      # Anonymous Reports (disable)
      KONG_ANONYMOUS_REPORTS: "off"
    ports:
      - "8000:8000"    # Proxy API (main entry point)
      - "8443:8443"    # Proxy API (HTTPS)
      - "8001:8001"    # Admin API
      - "8444:8444"    # Admin API (HTTPS)
      - "8002:8002"    # Kong Manager (GUI)
      - "8445:8445"    # Kong Manager (HTTPS)
    volumes:
      - ./kong.yml:/kong/declarative/kong.yml:ro
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - security-triage-network
    restart: unless-stopped

  # =============================================================================
  # Stage 1: Core Ingestion Services
  # =============================================================================

  # Alert Ingestor Service
  alert-ingestor:
    build:
      context: .
      dockerfile: services/alert_ingestor/Dockerfile
    container_name: security-triage-alert-ingestor
    environment:
      # Database
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://triage_user:${DB_PASSWORD:-triage_password_change_me}@localhost:5432/security_triage}
      # Redis
      REDIS_URL: ${REDIS_URL:-redis://:${REDIS_PASSWORD:-redis_password_change_me}@localhost:6379/0}
      # RabbitMQ
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://admin:${RABBITMQ_PASSWORD:-rabbitmq_password_change_me}@localhost:5672/}
      # Application
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DEBUG: "false"
    ports:
      - "9001:8000"    # Changed from 8001 to 9001 (9000+ range for direct access)
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: curl -f http://localhost:8000/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - security-triage-network
    restart: unless-stopped

  # Alert Normalizer Service
  alert-normalizer:
    build:
      context: .
      dockerfile: services/alert_normalizer/Dockerfile
    container_name: security-triage-alert-normalizer
    environment:
      # Database
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://triage_user:${DB_PASSWORD:-triage_password_change_me}@localhost:5432/security_triage}
      # Redis
      REDIS_URL: ${REDIS_URL:-redis://:${REDIS_PASSWORD:-redis_password_change_me}@localhost:6379/0}
      # RabbitMQ
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://admin:${RABBITMQ_PASSWORD:-rabbitmq_password_change_me}@localhost:5672/}
      # Application
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DEBUG: "false"
    ports:
      - "9002:8000"    # Changed from 8002 to 9002 (9000+ range for direct access)
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      alert-ingestor:
        condition: service_healthy
    healthcheck:
      test: curl -f http://localhost:8000/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - security-triage-network
    restart: unless-stopped

  # =============================================================================
  # Stage 2: Data Enrichment Services
  # =============================================================================

  # Context Collector Service
  context-collector:
    build:
      context: .
      dockerfile: services/context_collector/Dockerfile
    container_name: security-triage-context-collector
    environment:
      # Database
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://triage_user:${DB_PASSWORD:-triage_password_change_me}@localhost:5432/security_triage}
      # Redis
      REDIS_URL: ${REDIS_URL:-redis://:${REDIS_PASSWORD:-redis_password_change_me}@localhost:6379/0}
      # RabbitMQ
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://admin:${RABBITMQ_PASSWORD:-rabbitmq_password_change_me}@localhost:5672/}
      # Application
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DEBUG: "false"
    ports:
      - "9003:8000"    # Changed from 8003 to 9003 (9000+ range for direct access)
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      alert-normalizer:
        condition: service_healthy
    healthcheck:
      test: curl -f http://localhost:8000/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - security-triage-network
    restart: unless-stopped

  # Threat Intel Aggregator Service
  threat-intel-aggregator:
    build:
      context: .
      dockerfile: services/threat_intel_aggregator/Dockerfile
    container_name: security-triage-threat-intel-aggregator
    environment:
      # Database
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://triage_user:${DB_PASSWORD:-triage_password_change_me}@localhost:5432/security_triage}
      # Redis
      REDIS_URL: ${REDIS_URL:-redis://:${REDIS_PASSWORD:-redis_password_change_me}@localhost:6379/0}
      # RabbitMQ
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://admin:${RABBITMQ_PASSWORD:-rabbitmq_password_change_me}@localhost:5672/}
      # Threat Intel API Keys
      VIRUSTOTAL_API_KEY: ${VIRUSTOTAL_API_KEY:-your_vt_key}
      ABUSECH_API_KEY: ${ABUSECH_API_KEY:-your_abusech_key}
      # Application
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DEBUG: "false"
    ports:
      - "9004:8000"    # Changed from 8004 to 9004 (9000+ range for direct access)
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      context-collector:
        condition: service_healthy
    healthcheck:
      test: curl -f http://localhost:8000/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - security-triage-network
    restart: unless-stopped

  # LLM Router Service
  llm-router:
    build:
      context: .
      dockerfile: services/llm_router/Dockerfile
    container_name: security-triage-llm-router
    environment:
      # Database
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://triage_user:${DB_PASSWORD:-triage_password_change_me}@localhost:5432/security_triage}
      # RabbitMQ
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://admin:${RABBITMQ_PASSWORD:-rabbitmq_password_change_me}@localhost:5672/}
      # MaaS Configuration
      DEEPSEEK_BASE_URL: ${DEEPSEEK_BASE_URL:-http://internal-maas.deepseek/v1}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-internal-key-123}
      QWEN_BASE_URL: ${QWEN_BASE_URL:-http://internal-maas.qwen/v1}
      QWEN_API_KEY: ${QWEN_API_KEY:-internal-key-456}
      # Application
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DEBUG: "false"
    ports:
      - "9005:8000"    # Changed from 8005 to 9005 (9000+ range for direct access)
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      threat-intel-aggregator:
        condition: service_healthy
    healthcheck:
      test: curl -f http://localhost:8000/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - security-triage-network
    restart: unless-stopped

  # =============================================================================
  # Stage 3: AI Analysis Services
  # =============================================================================

  # AI Triage Agent Service
  ai-triage-agent:
    build:
      context: .
      dockerfile: services/ai_triage_agent/Dockerfile
    container_name: security-triage-ai-triage-agent
    environment:
      # Database
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://triage_user:${DB_PASSWORD:-triage_password_change_me}@localhost:5432/security_triage}
      # Redis
      REDIS_URL: ${REDIS_URL:-redis://:${REDIS_PASSWORD:-redis_password_change_me}@localhost:6379/0}
      # RabbitMQ
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://admin:${RABBITMQ_PASSWORD:-rabbitmq_password_change_me}@localhost:5672/}
      # LLM Router
      LLM_ROUTER_URL: ${LLM_ROUTER_URL:-http://llm-router:8000}
      # MaaS Configuration (fallback if router unavailable)
      DEEPSEEK_BASE_URL: ${DEEPSEEK_BASE_URL:-http://internal-maas.deepseek/v1}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-internal-key-123}
      QWEN_BASE_URL: ${QWEN_BASE_URL:-http://internal-maas.qwen/v1}
      QWEN_API_KEY: ${QWEN_API_KEY:-internal-key-456}
      # Application
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DEBUG: "false"
    ports:
      - "9006:8000"    # Changed from 8006 to 9006 (9000+ range for direct access)
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      llm-router:
        condition: service_healthy
    healthcheck:
      test: curl -f http://localhost:8000/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - security-triage-network
    restart: unless-stopped

  # Similarity Search Service
  similarity-search:
    build:
      context: .
      dockerfile: services/similarity_search/Dockerfile
    container_name: security-triage-similarity-search
    environment:
      # Database
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://triage_user:${DB_PASSWORD:-triage_password_change_me}@localhost:5432/security_triage}
      # Redis
      REDIS_URL: ${REDIS_URL:-redis://:${REDIS_PASSWORD:-redis_password_change_me}@localhost:6379/0}
      # RabbitMQ
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://admin:${RABBITMQ_PASSWORD:-rabbitmq_password_change_me}@localhost:5672/}
      # ChromaDB
      CHROMADB_HOST: ${CHROMADB_HOST:-chromadb}
      CHROMADB_PORT: ${CHROMADB_PORT:-8000}
      # Embedding Model
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-all-MiniLM-L6-v2}
      # Application
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DEBUG: "false"
    ports:
      - "9007:8000"    # Changed from 8007 to 9007 (9000+ range for direct access)
    volumes:
      - chroma_data:/app/data/chroma
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      chromadb:
        condition: service_healthy
    healthcheck:
      test: curl -f http://localhost:8000/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - security-triage-network
    restart: unless-stopped

  # =============================================================================
  # Stage 4: Workflow & Automation Services
  # =============================================================================

  # Workflow Engine Service
  workflow-engine:
    build:
      context: .
      dockerfile: services/workflow_engine/Dockerfile
    container_name: security-triage-workflow-engine
    environment:
      # Database
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://triage_user:${DB_PASSWORD:-triage_password_change_me}@localhost:5432/security_triage}
      # Redis
      REDIS_URL: ${REDIS_URL:-redis://:${REDIS_PASSWORD:-redis_password_change_me}@localhost:6379/0}
      # RabbitMQ
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://admin:${RABBITMQ_PASSWORD:-rabbitmq_password_change_me}@localhost:5672/}
      # Application
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DEBUG: "false"
    ports:
      - "9008:8000"    # Changed from 8008 to 9008 (9000+ range for direct access)
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      ai-triage-agent:
        condition: service_healthy
    healthcheck:
      test: curl -f http://localhost:8000/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - security-triage-network
    restart: unless-stopped

  # Automation Orchestrator Service
  automation-orchestrator:
    build:
      context: .
      dockerfile: services/automation_orchestrator/Dockerfile
    container_name: security-triage-automation-orchestrator
    environment:
      # Database
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://triage_user:${DB_PASSWORD:-triage_password_change_me}@localhost:5432/security_triage}
      # Redis
      REDIS_URL: ${REDIS_URL:-redis://:${REDIS_PASSWORD:-redis_password_change_me}@localhost:6379/0}
      # RabbitMQ
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://admin:${RABBITMQ_PASSWORD:-rabbitmq_password_change_me}@localhost:5672/}
      # Application
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DEBUG: "false"
    ports:
      - "9009:8000"    # Changed from 8009 to 9009 (9000+ range for direct access)
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      workflow-engine:
        condition: service_healthy
    healthcheck:
      test: curl -f http://localhost:8000/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - security-triage-network
    restart: unless-stopped

  # Notification Service
  notification-service:
    build:
      context: .
      dockerfile: services/notification_service/Dockerfile
    container_name: security-triage-notification-service
    environment:
      # Database
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://triage_user:${DB_PASSWORD:-triage_password_change_me}@localhost:5432/security_triage}
      # Redis
      REDIS_URL: ${REDIS_URL:-redis://:${REDIS_PASSWORD:-redis_password_change_me}@localhost:6379/0}
      # RabbitMQ
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://admin:${RABBITMQ_PASSWORD:-rabbitmq_password_change_me}@localhost:5672/}
      # Notification Channels
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-your-email@gmail.com}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-your-app-password}
      SLACK_WEBHOOK_URL: ${SLACK_WEBHOOK_URL:-https://hooks.slack.com/services/YOUR/WEBHOOK/URL}
      # Application
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DEBUG: "false"
    ports:
      - "9010:8000"    # Changed from 8010 to 9010 (9000+ range for direct access)
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      automation-orchestrator:
        condition: service_healthy
    healthcheck:
      test: curl -f http://localhost:8000/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - security-triage-network
    restart: unless-stopped

  # =============================================================================
  # Stage 5: Support Services & Frontend
  # =============================================================================

  # Data Analytics Service
  data-analytics:
    build:
      context: .
      dockerfile: services/data_analytics/Dockerfile
    container_name: security-triage-data-analytics
    environment:
      # Database
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://triage_user:${DB_PASSWORD:-triage_password_change_me}@localhost:5432/security_triage}
      # Redis
      REDIS_URL: ${REDIS_URL:-redis://:${REDIS_PASSWORD:-redis_password_change_me}@localhost:6379/0}
      # Application
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DEBUG: "false"
    ports:
      - "9011:8000"    # Changed from 8011 to 9011 (9000+ range for direct access)
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: curl -f http://localhost:8000/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - security-triage-network
    restart: unless-stopped

  # Reporting Service
  reporting-service:
    build:
      context: .
      dockerfile: services/reporting_service/Dockerfile
    container_name: security-triage-reporting-service
    environment:
      # Database
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://triage_user:${DB_PASSWORD:-triage_password_change_me}@localhost:5432/security_triage}
      # Redis
      REDIS_URL: ${REDIS_URL:-redis://:${REDIS_PASSWORD:-redis_password_change_me}@localhost:6379/0}
      # Application
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DEBUG: "false"
    ports:
      - "9012:8000"    # Changed from 8012 to 9012 (9000+ range for direct access)
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      data-analytics:
        condition: service_healthy
    healthcheck:
      test: curl -f http://localhost:8000/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - security-triage-network
    restart: unless-stopped

  # Configuration Service
  configuration-service:
    build:
      context: .
      dockerfile: services/configuration_service/Dockerfile
    container_name: security-triage-configuration-service
    environment:
      # Database
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://triage_user:${DB_PASSWORD:-triage_password_change_me}@localhost:5432/security_triage}
      # Redis
      REDIS_URL: ${REDIS_URL:-redis://:${REDIS_PASSWORD:-redis_password_change_me}@localhost:6379/0}
      # Application
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DEBUG: "false"
    ports:
      - "9013:8000"    # Changed from 8013 to 9013 (9000+ range for direct access)
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: curl -f http://localhost:8000/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - security-triage-network
    restart: unless-stopped

  # Monitoring Metrics Service
  monitoring-metrics:
    build:
      context: .
      dockerfile: services/monitoring_metrics/Dockerfile
    container_name: security-triage-monitoring-metrics
    environment:
      # Database
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://triage_user:${DB_PASSWORD:-triage_password_change_me}@localhost:5432/security_triage}
      # Redis
      REDIS_URL: ${REDIS_URL:-redis://:${REDIS_PASSWORD:-redis_password_change_me}@localhost:6379/0}
      # Prometheus
      PROMETHEUS_URL: ${PROMETHEUS_URL:-http://prometheus:9090}
      # Application
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DEBUG: "false"
    ports:
      - "9014:8000"    # Changed from 8014 to 9014 (9000+ range for direct access)
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      prometheus:
        condition: service_healthy
    healthcheck:
      test: curl -f http://localhost:8000/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - security-triage-network
    restart: unless-stopped

  # Web Dashboard (React Frontend)
  web-dashboard:
    build:
      context: .
      dockerfile: services/web_dashboard/Dockerfile
    container_name: security-triage-web-dashboard
    environment:
      # Backend Services
      API_BASE_URL: ${API_BASE_URL:-http://localhost:8001}
      ANALYTICS_SERVICE_URL: ${ANALYTICS_SERVICE_URL:-http://data-analytics:8000}
      REPORTING_SERVICE_URL: ${REPORTING_SERVICE_URL:-http://reporting-service:8000}
      CONFIG_SERVICE_URL: ${CONFIG_SERVICE_URL:-http://configuration-service:8000}
      # Application
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DEBUG: "false"
    ports:
      - "9015:8000"    # Changed from 8015 to 9015 (9000+ range for direct access)
    depends_on:
      data-analytics:
        condition: service_healthy
      reporting-service:
        condition: service_healthy
      configuration-service:
        condition: service_healthy
    healthcheck:
      test: curl -f http://localhost:8000/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - security-triage-network
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local
  chroma_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

networks:
  security-triage-network:
    driver: bridge
