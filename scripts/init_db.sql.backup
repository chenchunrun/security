-- Copyright 2026 CCR <chenchunrun@gmail.com>
--
-- Licensed under the Apache License, Version 2.0 (the "License");
-- you may not use this file except in compliance with the License.
-- You may obtain a copy of the License at
--
--     http://www.apache.org/licenses/LICENSE-2.0
--
-- Unless required by applicable law or agreed to in writing, software
-- distributed under the License is distributed on an "AS IS" BASIS,
-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-- See the License for the specific language governing permissions and
-- limitations under the License.

 =============================================================================
-- Security Triage System - Complete Database Initialization Script
-- =============================================================================
-- Version: 1.0
-- Date: 2026-01-08
-- Database: PostgreSQL 15+
--
-- This script initializes the complete database schema for the security
-- alert triage system, including all tables, indexes, triggers, partitions,
-- views, and initial data setup.
--
-- Usage:
--   psql -h localhost -U postgres -d security_triage -f init_db.sql
-- =============================================================================

-- =============================================================================
-- 1. Extensions
-- =============================================================================

-- UUID generation
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Trigram text search for improved LIKE queries
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- Cryptographic functions
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- Cron job scheduling (optional, for automated cleanup)
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- =============================================================================
-- 2. Functions
-- =============================================================================

-- Function: Update updated_at timestamp automatically
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Function: Generate alert ID from timestamp
CREATE OR REPLACE FUNCTION generate_alert_id()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.alert_id IS NULL THEN
        NEW.alert_id = 'ALT-' || TO_CHAR(NOW(), 'YYYYMMDD-HH24MISS') || '-' || substr(md5(random()::text), 1, 4);
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- 3. Tables
-- =============================================================================

-- -----------------------------------------------------------------------------
-- 3.1 Users Table
-- -----------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS users (
    -- Primary key
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    -- User information
    username VARCHAR(100) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    full_name VARCHAR(255),
    phone VARCHAR(20),

    -- Authentication
    password_hash VARCHAR(255) NOT NULL,
    mfa_enabled BOOLEAN DEFAULT false,
    mfa_secret VARCHAR(255),

    -- Status
    is_active BOOLEAN DEFAULT true,
    is_verified BOOLEAN DEFAULT false,

    -- Role and permissions
    role VARCHAR(50) DEFAULT 'analyst' CHECK (role IN (
        'admin', 'supervisor', 'analyst', 'viewer', 'auditor'
    )),

    -- Organization
    department VARCHAR(100),
    team VARCHAR(100),
    manager_id UUID REFERENCES users(id),

    -- Skills
    skills TEXT[] DEFAULT '{}',

    -- Timestamps
    last_login_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Trigger: Auto-update updated_at
CREATE TRIGGER update_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Indexes
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_is_active ON users(is_active);

-- -----------------------------------------------------------------------------
-- 3.2 Assets Table
-- -----------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS assets (
    -- Primary key
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    -- Asset identification
    asset_id VARCHAR(100) UNIQUE NOT NULL,
    asset_name VARCHAR(255) NOT NULL,
    asset_type VARCHAR(50) NOT NULL CHECK (asset_type IN (
        'server', 'workstation', 'network', 'database', 'application', 'other'
    )),

    -- Network information
    ip_address INET,
    mac_address MACADDR,
    hostname VARCHAR(255),

    -- Environment
    environment VARCHAR(20) CHECK (environment IN (
        'production', 'staging', 'development', 'test'
    )),

    -- Criticality
    criticality VARCHAR(20) DEFAULT 'medium' CHECK (criticality IN (
        'critical', 'high', 'medium', 'low'
    )),

    -- Ownership
    owner VARCHAR(255),
    owner_department VARCHAR(100),
    business_unit VARCHAR(100),

    -- System information
    os_name VARCHAR(100),
    os_version VARCHAR(100),
    platform VARCHAR(50),

    -- Vulnerability info
    vulnerability_count JSONB DEFAULT '{}',
    patch_status VARCHAR(20) DEFAULT 'unknown',

    -- Location
    location VARCHAR(100),
    data_center VARCHAR(100),

    -- Timestamps
    last_scan_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Trigger
CREATE TRIGGER update_assets_updated_at
    BEFORE UPDATE ON assets
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Indexes
CREATE INDEX idx_assets_asset_id ON assets(asset_id);
CREATE INDEX idx_assets_ip_address ON assets(ip_address);
CREATE INDEX idx_assets_hostname ON assets(hostname);
CREATE INDEX idx_assets_criticality ON assets(criticality);
CREATE INDEX idx_assets_environment ON assets(environment);

-- -----------------------------------------------------------------------------
-- 3.3 Alerts Table
-- -----------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS alerts (
    -- Primary key
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    -- Alert identification
    alert_id VARCHAR(100) UNIQUE NOT NULL,
    ingestion_id VARCHAR(100),

    -- Alert content
    original_json JSONB NOT NULL,
    normalized_json JSONB,

    -- Alert classification
    alert_type VARCHAR(50) NOT NULL,
    severity VARCHAR(20) NOT NULL CHECK (severity IN ('critical', 'high', 'medium', 'low', 'info')),
    category VARCHAR(50),

    -- Network information
    source_ip INET,
    source_port INT,
    target_ip INET,
    target_port INT,
    protocol VARCHAR(20),

    -- IOC information
    file_hash VARCHAR(128),
    domain VARCHAR(255),
    url TEXT,
    email VARCHAR(255),

    -- Description
    title VARCHAR(500),
    description TEXT,

    -- Relationships
    asset_id UUID REFERENCES assets(id),
    user_id UUID REFERENCES users(id),

    -- Status
    status VARCHAR(20) DEFAULT 'new' CHECK (status IN (
        'new', 'assigned', 'in_progress', 'resolved', 'rejected', 'closed'
    )),
    assigned_to UUID REFERENCES users(id),

    -- AI triage results
    risk_score FLOAT CHECK (risk_score BETWEEN 0 AND 100),
    risk_level VARCHAR(20) CHECK (risk_level IN ('critical', 'high', 'medium', 'low', 'info')),
    confidence FLOAT CHECK (confidence BETWEEN 0 AND 1),
    requires_human_review BOOLEAN DEFAULT false,
    triage_result_id UUID,

    -- Timestamps
    received_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    first_seen_at TIMESTAMP WITH TIME ZONE,
    last_seen_at TIMESTAMP WITH TIME ZONE,
    resolved_at TIMESTAMP WITH TIME ZONE,
    closed_at TIMESTAMP WITH TIME ZONE,

    -- Metadata
    source_system VARCHAR(100),
    tags TEXT[] DEFAULT '{}',
    labels JSONB DEFAULT '{}'
);

-- Triggers
CREATE TRIGGER generate_alert_id_trigger
    BEFORE INSERT ON alerts
    FOR EACH ROW
    EXECUTE FUNCTION generate_alert_id();

CREATE TRIGGER update_alerts_updated_at
    BEFORE UPDATE ON alerts
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Indexes
CREATE INDEX idx_alerts_alert_id ON alerts(alert_id);
CREATE INDEX idx_alerts_status ON alerts(status);
CREATE INDEX idx_alerts_severity ON alerts(severity);
CREATE INDEX idx_alerts_risk_score ON alerts(risk_score);
CREATE INDEX idx_alerts_created_at ON alerts(created_at DESC);
CREATE INDEX idx_alerts_source_ip ON alerts(source_ip);
CREATE INDEX idx_alerts_assigned_to ON alerts(assigned_to);
CREATE INDEX idx_alerts_tags ON alerts USING GIN(tags);
CREATE INDEX idx_alerts_gin_labels ON alerts USING GIN(labels);

-- -----------------------------------------------------------------------------
-- 3.4 Triage Results Table
-- -----------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS triage_results (
    -- Primary key
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    alert_id UUID NOT NULL REFERENCES alerts(id) ON DELETE CASCADE,

    -- Risk assessment
    risk_score FLOAT NOT NULL CHECK (risk_score BETWEEN 0 AND 100),
    risk_level VARCHAR(20) NOT NULL,
    confidence FLOAT NOT NULL CHECK (confidence BETWEEN 0 AND 1),

    -- Key factors
    key_factors TEXT[] NOT NULL,

    -- Score components
    severity_score FLOAT,
    threat_intel_score FLOAT,
    asset_criticality_score FLOAT,
    exploitability_score FLOAT,

    -- Remediation
    remediation JSONB NOT NULL,

    -- Similar alerts
    similar_alerts JSONB DEFAULT '[]',

    -- AI analysis
    ai_analysis JSONB,

    -- Performance metrics
    processing_time_ms INT,

    -- Model information
    model_used VARCHAR(100),
    model_version VARCHAR(50),

    -- Timestamp
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_triage_results_alert_id ON triage_results(alert_id);
CREATE INDEX idx_triage_results_risk_score ON triage_results(risk_score);
CREATE INDEX idx_triage_results_created_at ON triage_results(created_at DESC);

-- Add foreign key to alerts
ALTER TABLE alerts ADD CONSTRAINT fk_alerts_triage_result
    FOREIGN KEY (triage_result_id) REFERENCES triage_results(id);

-- -----------------------------------------------------------------------------
-- 3.5 Threat Intelligence Table
-- -----------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS threat_intel (
    -- Primary key
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    -- IOC information
    ioc VARCHAR(500) NOT NULL,
    ioc_type VARCHAR(20) NOT NULL CHECK (ioc_type IN (
        'ip', 'domain', 'hash', 'url', 'email'
    )),

    -- Threat assessment
    threat_level VARCHAR(20) CHECK (threat_level IN (
        'critical', 'high', 'medium', 'low', 'info'
    )),
    threat_score FLOAT CHECK (threat_score BETWEEN 0 AND 10),
    confidence FLOAT CHECK (confidence BETWEEN 0 AND 1),

    -- Malicious determination
    is_malicious BOOLEAN DEFAULT false,
    classification VARCHAR(50),

    -- Sources
    sources JSONB NOT NULL DEFAULT '[]',
    source_count INT DEFAULT 0,

    -- Related information
    tags TEXT[] DEFAULT '{}',
    campaigns TEXT[] DEFAULT '{}',
    malware_families TEXT[] DEFAULT '{}',

    -- Time information
    first_seen TIMESTAMP WITH TIME ZONE,
    last_seen TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    -- TTL (cache expiration)
    ttl INTERVAL DEFAULT '24 hours',
    expires_at TIMESTAMP WITH TIME ZONE GENERATED ALWAYS AS (updated_at + ttl) STORED,

    -- Unique constraint
    UNIQUE(ioc, ioc_type)
);

-- Trigger
CREATE TRIGGER update_threat_intel_updated_at
    BEFORE UPDATE ON threat_intel
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Indexes
CREATE INDEX idx_threat_intel_ioc ON threat_intel(ioc);
CREATE INDEX idx_threat_intel_ioc_type ON threat_intel(ioc_type);
CREATE INDEX idx_threat_intel_threat_level ON threat_intel(threat_level);
CREATE INDEX idx_threat_intel_is_malicious ON threat_intel(is_malicious);
CREATE INDEX idx_threat_intel_expires_at ON threat_intel(expires_at);
CREATE INDEX idx_threat_intel_gin_tags ON threat_intel USING GIN(tags);

-- -----------------------------------------------------------------------------
-- 3.6 Alert Context Table
-- -----------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS alert_context (
    -- Primary key
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    alert_id UUID NOT NULL REFERENCES alerts(id) ON DELETE CASCADE,

    -- Context type
    context_type VARCHAR(20) NOT NULL CHECK (context_type IN (
        'network', 'asset', 'user', 'geo', 'vulnerability'
    )),

    -- Context data
    context_data JSONB NOT NULL,

    -- Timestamps
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    -- Unique constraint
    UNIQUE(alert_id, context_type)
);

-- Trigger
CREATE TRIGGER update_alert_context_updated_at
    BEFORE UPDATE ON alert_context
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Indexes
CREATE INDEX idx_alert_context_alert_id ON alert_context(alert_id);
CREATE INDEX idx_alert_context_type ON alert_context(context_type);

-- -----------------------------------------------------------------------------
-- 3.7 Incidents Table
-- -----------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS incidents (
    -- Primary key
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    incident_id VARCHAR(100) UNIQUE NOT NULL,

    -- Related alerts
    alert_ids UUID[] NOT NULL,

    -- Incident information
    title VARCHAR(500) NOT NULL,
    description TEXT,
    incident_type VARCHAR(50),

    -- Severity
    severity VARCHAR(20) NOT NULL CHECK (severity IN (
        'critical', 'high', 'medium', 'low'
    )),

    -- Status
    status VARCHAR(20) DEFAULT 'open' CHECK (status IN (
        'open', 'investigating', 'contained', 'eradicated', 'resolved', 'closed'
    )),

    -- Assignment
    assigned_to UUID REFERENCES users(id),
    team VARCHAR(100),

    -- Timeline
    detected_at TIMESTAMP WITH TIME ZONE NOT NULL,
    reported_at TIMESTAMP WITH TIME ZONE,
    contained_at TIMESTAMP WITH TIME ZONE,
    eradicated_at TIMESTAMP WITH TIME ZONE,
    resolved_at TIMESTAMP WITH TIME ZONE,
    closed_at TIMESTAMP WITH TIME ZONE,

    -- Impact
    impact_assessment JSONB,
    affected_assets UUID[] REFERENCES assets(id),

    -- Root cause analysis
    root_cause TEXT,
    kill_chain JSONB,

    -- Response actions
    response_actions JSONB DEFAULT '[]',
    lessons_learned TEXT,

    -- Metadata
    created_by UUID REFERENCES users(id),
    updated_by UUID REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Trigger
CREATE TRIGGER update_incidents_updated_at
    BEFORE UPDATE ON incidents
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Indexes
CREATE INDEX idx_incidents_incident_id ON incidents(incident_id);
CREATE INDEX idx_incidents_status ON incidents(status);
CREATE INDEX idx_incidents_severity ON incidents(severity);
CREATE INDEX idx_incidents_assigned_to ON incidents(assigned_to);
CREATE INDEX idx_incidents_created_at ON incidents(created_at DESC);

-- -----------------------------------------------------------------------------
-- 3.8 Remediation Actions Table (Enhanced)
-- -----------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS remediation_actions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    alert_id UUID NOT NULL REFERENCES alerts(id) ON DELETE CASCADE,

    -- Action details
    action_type VARCHAR(100) NOT NULL,
    priority VARCHAR(20) NOT NULL,
    title VARCHAR(500) NOT NULL,
    description TEXT,

    -- Execution
    is_automated BOOLEAN DEFAULT false,
    status VARCHAR(50) DEFAULT 'pending',
    assigned_to VARCHAR(255),
    completed_at TIMESTAMP WITH TIME ZONE,
    execution_result JSONB,

    -- Metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    -- Constraints
    CONSTRAINT priority_check CHECK (priority IN (
        'immediate', 'high', 'medium', 'low'
    )),
    CONSTRAINT action_status_check CHECK (status IN (
        'pending', 'in_progress', 'completed', 'failed', 'skipped'
    ))
);

-- Trigger
CREATE TRIGGER update_remediation_actions_updated_at
    BEFORE UPDATE ON remediation_actions
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Indexes
CREATE INDEX idx_remediation_alert_id ON remediation_actions(alert_id);
CREATE INDEX idx_remediation_priority ON remediation_actions(priority);
CREATE INDEX idx_remediation_status ON remediation_actions(status);
CREATE INDEX idx_remediation_is_automated ON remediation_actions(is_automated);
CREATE INDEX idx_remediation_created_at ON remediation_actions(created_at DESC);

-- -----------------------------------------------------------------------------
-- 3.9 Audit Logs Table
-- -----------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS audit_logs (
    -- Primary key
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    -- Actor information
    actor_id UUID REFERENCES users(id),
    actor_type VARCHAR(20) CHECK (actor_type IN ('user', 'system', 'api')),
    action VARCHAR(100) NOT NULL,

    -- Resource information
    resource_type VARCHAR(50),
    resource_id UUID,

    -- Changes
    old_values JSONB,
    new_values JSONB,

    -- Request information
    ip_address INET,
    user_agent TEXT,
    request_id VARCHAR(100),

    -- Result
    status VARCHAR(20) DEFAULT 'success' CHECK (status IN ('success', 'failure', 'partial')),
    error_message TEXT,

    -- Timestamp
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_audit_logs_actor_id ON audit_logs(actor_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_resource ON audit_logs(resource_type, resource_id);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at DESC);

-- =============================================================================
-- 4. Views for Common Queries
-- =============================================================================

-- View: Active alerts with triage results
CREATE OR REPLACE VIEW v_active_alerts AS
SELECT
    a.alert_id,
    a.title,
    a.severity,
    a.status,
    a.risk_score,
    a.risk_level,
    a.requires_human_review,
    a.assigned_to,
    u_assign.username AS assigned_to_username,
    a.created_at,
    tr.key_factors,
    tr.remediation
FROM alerts a
LEFT JOIN users u_assign ON a.assigned_to = u_assign.id
LEFT JOIN triage_results tr ON a.triage_result_id = tr.id
WHERE a.status NOT IN ('resolved', 'closed')
ORDER BY a.created_at DESC;

-- View: Alert statistics by severity
CREATE OR REPLACE VIEW v_alert_stats_by_severity AS
SELECT
    severity,
    COUNT(*) AS total_count,
    COUNT(*) FILTER (WHERE status = 'new') AS new_count,
    COUNT(*) FILTER (WHERE status IN ('assigned', 'in_progress')) AS open_count,
    COUNT(*) FILTER (WHERE status = 'resolved') AS resolved_count,
    AVG(risk_score) AS avg_risk_score
FROM alerts
GROUP BY severity;

-- View: Top critical assets
CREATE OR REPLACE VIEW v_critical_assets AS
SELECT
    asset_id,
    asset_name,
    asset_type,
    ip_address,
    hostname,
    criticality,
    COUNT(a.id) AS alert_count,
    COUNT(a.id) FILTER (WHERE a.severity = 'critical') AS critical_alert_count
FROM assets ast
LEFT JOIN alerts a ON ast.id = a.asset_id
GROUP BY ast.id, ast.asset_id, ast.asset_name, ast.asset_type,
         ast.ip_address, ast.hostname, ast.criticality
ORDER BY criticality DESC, alert_count DESC;

-- =============================================================================
-- 5. Initial Data
-- =============================================================================

-- Default admin user (password: admin123 - CHANGE THIS!)
INSERT INTO users (username, email, full_name, password_hash, role, is_active, is_verified) VALUES
('admin', 'admin@security-triage.local', 'System Administrator',
 crypt('admin123', gen_salt('bf8')), 'admin', true, true)
ON CONFLICT (username) DO NOTHING;

-- Default analyst user (password: analyst123)
INSERT INTO users (username, email, full_name, password_hash, role, is_active, is_verified) VALUES
('analyst', 'analyst@security-triage.local', 'Security Analyst',
 crypt('analyst123', gen_salt('bf8')), 'analyst', true, true)
ON CONFLICT (username) DO NOTHING;

-- Sample assets
INSERT INTO assets (asset_id, asset_name, asset_type, ip_address, hostname, environment, criticality, owner, os_name) VALUES
('SRV-001', 'Web Server 01', 'server', '10.0.1.10', 'web01', 'production', 'critical', 'IT Team', 'Ubuntu 22.04'),
('SRV-002', 'Database Server 01', 'database', '10.0.1.20', 'db01', 'production', 'critical', 'DBA Team', 'Ubuntu 22.04'),
('WS-001', 'Workstation 01', 'workstation', '10.0.2.100', 'hr-laptop-01', 'production', 'medium', 'HR Department', 'Windows 11'),
('NET-001', 'Firewall 01', 'network', '10.0.0.1', 'fw01', 'production', 'high', 'Network Team', 'Cisco ASA')
ON CONFLICT (asset_id) DO NOTHING;

-- Sample alerts
INSERT INTO alerts (alert_id, received_at, alert_type, severity, title, description, source_ip, target_ip, source_system) VALUES
('ALT-2025-001', NOW(), 'malware', 'high', 'Malware Detected', 'Detected suspicious file execution on endpoint', '45.33.32.156', '10.0.0.50', 'EDR'),
('ALT-2025-002', NOW() - INTERVAL '30 minutes', 'brute_force', 'medium', 'Brute Force Attack', 'Multiple failed login attempts detected', '192.168.1.200', '10.0.0.10', 'SIEM'),
('ALT-2025-003', NOW() - INTERVAL '1 hour', 'anomaly', 'low', 'Network Anomaly', 'Unusual network traffic pattern detected', '10.0.1.50', '10.0.0.100', 'NDR'),
('ALT-2025-004', NOW() - INTERVAL '2 hours', 'data_exfiltration', 'critical', 'Data Exfiltration', 'Large data transfer to external IP detected', '10.0.0.75', '203.0.113.45', 'DLP')
ON CONFLICT (alert_id) DO NOTHING;

-- Sample threat intel
INSERT INTO threat_intel (ioc, ioc_type, threat_level, threat_score, is_malicious, sources) VALUES
('45.33.32.156', 'ip', 'critical', 9.5, true, '[{"name": "VirusTotal", "detection_rate": 0.8}, {"name": "Abuse.ch", "listed": true}]'::jsonb),
('5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8', 'hash', 'high', 7.8, true, '[{"name": "VirusTotal", "positives": 45, "total": 60}]'::jsonb)
ON CONFLICT (ioc, ioc_type) DO NOTHING;

-- =============================================================================
-- 6. Scheduled Jobs
-- =============================================================================

-- Cleanup expired threat intel (runs hourly)
SELECT cron.schedule('cleanup-expired-threat-intel', '0 * * * *', $$
    DELETE FROM threat_intel WHERE expires_at < NOW();
$$) ON CONFLICT (cronname) DO NOTHING;

-- =============================================================================
-- 7. Grant Permissions
-- =============================================================================

-- Create application user if not exists
DO $$
BEGIN
  IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'triage_user') THEN
    CREATE ROLE triage_user WITH LOGIN PASSWORD 'change_me_in_production';
  END IF;
END
$$;

-- Grant permissions on all tables
GRANT USAGE ON SCHEMA public TO triage_user;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO triage_user;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO triage_user;

-- =============================================================================
-- 8. Vacuum and Analyze
-- =============================================================================

VACUUM ANALYZE;

-- =============================================================================
-- Script Complete
-- =============================================================================
DO $$
BEGIN
    RAISE NOTICE 'Security Triage System database initialization completed successfully!';
    RAISE NOTICE 'Default users: admin/admin123, analyst/analyst123 (CHANGE THESE IN PRODUCTION!)';
END $$;
