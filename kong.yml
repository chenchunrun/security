# Copyright 2026 CCR <chenchunrun@gmail.com>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#
# Kong Declarative Configuration File
#
# This file defines the complete Kong API Gateway configuration for the
# Security Alert Triage System, including all 15 microservices, JWT authentication,
# rate limiting, and monitoring.
#
# Documentation: https://docs.konghq.com/gateway/latest/deck/declarative/
#

_format_version: "3.0"
_transform: true

# =============================================================================
# UPSTREAM SERVICES (Backend Microservices)
# =============================================================================

# Stage 1: Core Ingestion Services
upstreams:
  # Alert Ingestor Service
  - name: alert-ingestor-service
    algorithm: round-robin
    slots: 10000
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 10
          successes: 2
          http_statuses:
            - 200
            - 204
        unhealthy:
          interval: 10
          http_failures: 3
          http_statuses:
            - 500
            - 502
            - 503
            - 504
    targets:
      - target: alert-ingestor:8000
        weight: 100

  # Alert Normalizer Service
  - name: alert-normalizer-service
    algorithm: round-robin
    slots: 10000
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 10
          successes: 2
          http_statuses:
            - 200
            - 204
        unhealthy:
          interval: 10
          http_failures: 3
          http_statuses:
            - 500
            - 502
            - 503
            - 504
    targets:
      - target: alert-normalizer:8000
        weight: 100

# Stage 2: Data Enrichment Services
  # Context Collector Service
  - name: context-collector-service
    algorithm: round-robin
    slots: 10000
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 10
          successes: 2
          http_statuses:
            - 200
            - 204
        unhealthy:
          interval: 10
          http_failures: 3
          http_statuses:
            - 500
            - 502
            - 503
            - 504
    targets:
      - target: context-collector:8000
        weight: 100

  # Threat Intel Aggregator Service
  - name: threat-intel-aggregator-service
    algorithm: round-robin
    slots: 10000
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 10
          successes: 2
          http_statuses:
            - 200
            - 204
        unhealthy:
          interval: 10
          http_failures: 3
          http_statuses:
            - 500
            - 502
            - 503
            - 504
    targets:
      - target: threat-intel-aggregator:8000
        weight: 100

  # LLM Router Service
  - name: llm-router-service
    algorithm: round-robin
    slots: 10000
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 10
          successes: 2
          http_statuses:
            - 200
            - 204
        unhealthy:
          interval: 10
          http_failures: 3
          http_statuses:
            - 500
            - 502
            - 503
            - 504
    targets:
      - target: llm-router:8000
        weight: 100

# Stage 3: AI Analysis Services
  # AI Triage Agent Service
  - name: ai-triage-agent-service
    algorithm: round-robin
    slots: 10000
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 10
          successes: 2
          http_statuses:
            - 200
            - 204
        unhealthy:
          interval: 10
          http_failures: 3
          http_statuses:
            - 500
            - 502
            - 503
            - 504
    targets:
      - target: ai-triage-agent:8000
        weight: 100

  # Similarity Search Service
  - name: similarity-search-service
    algorithm: round-robin
    slots: 10000
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 10
          successes: 2
          http_statuses:
            - 200
            - 204
        unhealthy:
          interval: 10
          http_failures: 3
          http_statuses:
            - 500
            - 502
            - 503
            - 504
    targets:
      - target: similarity-search:8000
        weight: 100

# Stage 4: Workflow & Automation Services
  # Workflow Engine Service
  - name: workflow-engine-service
    algorithm: round-robin
    slots: 10000
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 10
          successes: 2
          http_statuses:
            - 200
            - 204
        unhealthy:
          interval: 10
          http_failures: 3
          http_statuses:
            - 500
            - 502
            - 503
            - 504
    targets:
      - target: workflow-engine:8000
        weight: 100

  # Automation Orchestrator Service
  - name: automation-orchestrator-service
    algorithm: round-robin
    slots: 10000
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 10
          successes: 2
          http_statuses:
            - 200
            - 204
        unhealthy:
          interval: 10
          http_failures: 3
          http_statuses:
            - 500
            - 502
            - 503
            - 504
    targets:
      - target: automation-orchestrator:8000
        weight: 100

  # Notification Service
  - name: notification-service-service
    algorithm: round-robin
    slots: 10000
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 10
          successes: 2
          http_statuses:
            - 200
            - 204
        unhealthy:
          interval: 10
          http_failures: 3
          http_statuses:
            - 500
            - 502
            - 503
            - 504
    targets:
      - target: notification-service:8000
        weight: 100

# Stage 5: Support Services & Frontend
  # Data Analytics Service
  - name: data-analytics-service
    algorithm: round-robin
    slots: 10000
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 10
          successes: 2
          http_statuses:
            - 200
            - 204
        unhealthy:
          interval: 10
          http_failures: 3
          http_statuses:
            - 500
            - 502
            - 503
            - 504
    targets:
      - target: data-analytics:8000
        weight: 100

  # Reporting Service
  - name: reporting-service-service
    algorithm: round-robin
    slots: 10000
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 10
          successes: 2
          http_statuses:
            - 200
            - 204
        unhealthy:
          interval: 10
          http_failures: 3
          http_statuses:
            - 500
            - 502
            - 503
            - 504
    targets:
      - target: reporting-service:8000
        weight: 100

  # Configuration Service
  - name: configuration-service-service
    algorithm: round-robin
    slots: 10000
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 10
          successes: 2
          http_statuses:
            - 200
            - 204
        unhealthy:
          interval: 10
          http_failures: 3
          http_statuses:
            - 500
            - 502
            - 503
            - 504
    targets:
      - target: configuration-service:8000
        weight: 100

  # Monitoring Metrics Service
  - name: monitoring-metrics-service
    algorithm: round-robin
    slots: 10000
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 10
          successes: 2
          http_statuses:
            - 200
            - 204
        unhealthy:
          interval: 10
          http_failures: 3
          http_statuses:
            - 500
            - 502
            - 503
            - 504
    targets:
      - target: monitoring-metrics:8000
        weight: 100

  # Web Dashboard (Frontend - Public, No Auth)
  - name: web-dashboard-service
    algorithm: round-robin
    slots: 10000
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 10
          successes: 2
          http_statuses:
            - 200
            - 204
        unhealthy:
          interval: 10
          http_failures: 3
          http_statuses:
            - 500
            - 502
            - 503
            - 504
    targets:
      - target: web-dashboard:8000
        weight: 100

# =============================================================================
# KONG SERVICES (API Definitions)
# =============================================================================

services:
  # Alert Ingestor API
  - name: alert-ingestor-api
    url: http://alert-ingestor-service:8000
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

  # Alert Normalizer API
  - name: alert-normalizer-api
    url: http://alert-normalizer-service:8000
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

  # Context Collector API
  - name: context-collector-api
    url: http://context-collector-service:8000
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

  # Threat Intel Aggregator API
  - name: threat-intel-aggregator-api
    url: http://threat-intel-aggregator-service:8000
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

  # LLM Router API
  - name: llm-router-api
    url: http://llm-router-service:8000
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

  # AI Triage Agent API
  - name: ai-triage-agent-api
    url: http://ai-triage-agent-service:8000
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

  # Similarity Search API
  - name: similarity-search-api
    url: http://similarity-search-service:8000
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

  # Workflow Engine API
  - name: workflow-engine-api
    url: http://workflow-engine-service:8000
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

  # Automation Orchestrator API
  - name: automation-orchestrator-api
    url: http://automation-orchestrator-service:8000
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

  # Notification Service API
  - name: notification-service-api
    url: http://notification-service-service:8000
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

  # Data Analytics API
  - name: data-analytics-api
    url: http://data-analytics-service:8000
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

  # Reporting Service API
  - name: reporting-service-api
    url: http://reporting-service-service:8000
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

  # Configuration Service API
  - name: configuration-service-api
    url: http://configuration-service-service:8000
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

  # Monitoring Metrics API
  - name: monitoring-metrics-api
    url: http://monitoring-metrics-service:8000
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

  # Web Dashboard (Public)
  - name: web-dashboard-api
    url: http://web-dashboard-service:8000
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

# =============================================================================
# ROUTES (API Paths)
# =============================================================================

routes:
  # Alert Ingestor Routes
  - name: alert-ingestor-ingest
    service: alert-ingestor-api
    paths:
      - /api/v1/alerts
    methods:
      - POST
    strip_path: false

  - name: alert-ingestor-batch
    service: alert-ingestor-api
    paths:
      - /api/v1/alerts/batch
    methods:
      - POST
    strip_path: false

  - name: alert-ingestor-webhook
    service: alert-ingestor-api
    paths:
      - /api/v1/webhooks
      - /webhooks
    methods:
      - POST
    strip_path: false

  # Alert Normalizer Routes
  - name: alert-normalizer-normalize
    service: alert-normalizer-api
    paths:
      - /api/v1/normalize
    methods:
      - POST
    strip_path: false

  # Context Collector Routes
  - name: context-collector-context
    service: context-collector-api
    paths:
      - /api/v1/context
    methods:
      - GET
      - POST
    strip_path: false

  # Threat Intel Aggregator Routes
  - name: threat-intel-query
    service: threat-intel-aggregator-api
    paths:
      - /api/v1/threat-intel
    methods:
      - GET
      - POST
    strip_path: false

  # LLM Router Routes
  - name: llm-router-route
    service: llm-router-api
    paths:
      - /api/v1/llm
    methods:
      - POST
    strip_path: false

  # AI Triage Agent Routes
  - name: ai-triage-analyze
    service: ai-triage-agent-api
    paths:
      - /api/v1/analyze
      - /api/v1/triage
    methods:
      - POST
    strip_path: false

  # Similarity Search Routes
  - name: similarity-search-search
    service: similarity-search-api
    paths:
      - /api/v1/similarity
    methods:
      - GET
      - POST
    strip_path: false

  # Workflow Engine Routes
  - name: workflow-engine-workflows
    service: workflow-engine-api
    paths:
      - /api/v1/workflows
    methods:
      - GET
      - POST
    strip_path: false

  - name: workflow-engine-workflow-detail
    service: workflow-engine-api
    paths:
      - /api/v1/workflows/(?<workflow_id>.*)
    strip_path: false

  # Automation Orchestrator Routes
  - name: automation-orchestrator-playbooks
    service: automation-orchestrator-api
    paths:
      - /api/v1/playbooks
      - /api/v1/automation
    methods:
      - GET
      - POST
    strip_path: false

  # Notification Service Routes
  - name: notification-service-notifications
    service: notification-service-api
    paths:
      - /api/v1/notifications
    methods:
      - GET
      - POST
    strip_path: false

  # Data Analytics Routes
  - name: data-analytics-metrics
    service: data-analytics-api
    paths:
      - /api/v1/metrics
      - /api/v1/analytics
    methods:
      - GET
    strip_path: false

  - name: data-analytics-trends
    service: data-analytics-api
    paths:
      - /api/v1/trends
    methods:
      - GET
    strip_path: false

  # Reporting Service Routes
  - name: reporting-service-reports
    service: reporting-service-api
    paths:
      - /api/v1/reports
    methods:
      - GET
      - POST
    strip_path: false

  - name: reporting-service-dashboard
    service: reporting-service-api
    paths:
      - /api/v1/dashboard
    methods:
      - GET
    strip_path: false

  # Configuration Service Routes
  - name: configuration-service-config
    service: configuration-service-api
    paths:
      - /api/v1/config
    methods:
      - GET
      - PUT
    strip_path: false

  - name: configuration-service-features
    service: configuration-service-api
    paths:
      - /api/v1/features
    methods:
      - GET
      - POST
    strip_path: false

  # Monitoring Metrics Routes
  - name: monitoring-metrics-prometheus
    service: monitoring-metrics-api
    paths:
      - /api/v1/metrics/prometheus
    methods:
      - GET
    strip_path: false

  # Web Dashboard Routes (Public, No Auth)
  - name: web-dashboard-root
    service: web-dashboard-api
    paths:
      - /
    strip_path: false

  - name: web-dashboard-static
    service: web-dashboard-api
    paths:
      - /static
    strip_path: false

  - name: web-dashboard-api
    service: web-dashboard-api
    paths:
      - /api
    strip_path: false

# =============================================================================
# PLUGINS (Cross-cutting Concerns)
# =============================================================================

plugins:
  # =============================================================================
  # CORS Plugin (Global)
  # =============================================================================
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - Authorization
        - X-Auth-Token
        - X-API-Key
      exposed_headers:
        - X-Total-Count
        - X-Request-ID
      max_age: 3600
      credentials: true

  # =============================================================================
  # Rate Limiting (Global)
  # =============================================================================
  - name: rate-limiting
    config:
      minute: 1000              # 1000 requests per minute
      hour: 10000               # 10000 requests per hour
      policy: redis
      redis_host: redis
      redis_port: 6379
      redis_password: ${REDIS_PASSWORD}
      redis_database: 1
      fault_tolerant: true

  # =============================================================================
  # Request Size Limiting
  # =============================================================================
  - name: request-size-limiting
    config:
      allowed_payload_size: 50  # 50 MB

  # =============================================================================
  # Request Transformer (Add Headers)
  # =============================================================================
  - name: request-transformer
    config:
      add:
        headers:
          - X-Kong-Request-ID:$(uuid)
          - X-Forwarded-By:kong-gateway

  # =============================================================================
  # Response Transformer (Add Headers)
  # =============================================================================
  - name: response-transformer
    config:
      add:
        headers:
          - X-Powered-By:Security-Triage-Gateway

# =============================================================================
# JWT PLUGIN (Authentication)
# =============================================================================

# Apply JWT authentication to all APIs except Web Dashboard
# Note: This is applied per-service to exclude the web dashboard

# Alert Ingestor - JWT Auth
  - name: jwt
    service: alert-ingestor-api
    config:
      key_claim_name: kid
      claims_to_verify:
        - exp

# Alert Normalizer - JWT Auth
  - name: jwt
    service: alert-normalizer-api
    config:
      key_claim_name: kid
      claims_to_verify:
        - exp

# Context Collector - JWT Auth
  - name: jwt
    service: context-collector-api
    config:
      key_claim_name: kid
      claims_to_verify:
        - exp

# Threat Intel Aggregator - JWT Auth
  - name: jwt
    service: threat-intel-aggregator-api
    config:
      key_claim_name: kid
      claims_to_verify:
        - exp

# LLM Router - JWT Auth
  - name: jwt
    service: llm-router-api
    config:
      key_claim_name: kid
      claims_to_verify:
        - exp

# AI Triage Agent - JWT Auth
  - name: jwt
    service: ai-triage-agent-api
    config:
      key_claim_name: kid
      claims_to_verify:
        - exp

# Similarity Search - JWT Auth
  - name: jwt
    service: similarity-search-api
    config:
      key_claim_name: kid
      claims_to_verify:
        - exp

# Workflow Engine - JWT Auth
  - name: jwt
    service: workflow-engine-api
    config:
      key_claim_name: kid
      claims_to_verify:
        - exp

# Automation Orchestrator - JWT Auth
  - name: jwt
    service: automation-orchestrator-api
    config:
      key_claim_name: kid
      claims_to_verify:
        - exp

# Notification Service - JWT Auth
  - name: jwt
    service: notification-service-api
    config:
      key_claim_name: kid
      claims_to_verify:
        - exp

# Data Analytics - JWT Auth
  - name: jwt
    service: data-analytics-api
    config:
      key_claim_name: kid
      claims_to_verify:
        - exp

# Reporting Service - JWT Auth
  - name: jwt
    service: reporting-service-api
    config:
      key_claim_name: kid
      claims_to_verify:
        - exp

# Configuration Service - JWT Auth
  - name: jwt
    service: configuration-service-api
    config:
      key_claim_name: kid
      claims_to_verify:
        - exp

# Monitoring Metrics - JWT Auth
  - name: jwt
    service: monitoring-metrics-api
    config:
      key_claim_name: kid
      claims_to_verify:
        - exp

# =============================================================================
# API KEY PLUGIN (Alternative Auth for Webhooks)
# =============================================================================

# Alert Ingestor - API Key for Webhooks
  - name: key-auth
    route: alert-ingestor-webhook
    config:
      key_names:
        - apikey
        - X-API-Key
      hide_credentials: true

# =============================================================================
# ACL PLUGIN (Role-Based Access Control)
# =============================================================================

# Apply ACL to workflow engine and automation orchestrator
  - name: acl
    service: workflow-engine-api
    config:
      allow:
        - admin
        - operator
      deny:
        - viewer

  - name: acl
    service: automation-orchestrator-api
    config:
      allow:
        - admin
        - operator
      deny:
        - viewer

# =============================================================================
# LOGGING PLUGINS
# =============================================================================

# File Logging (Development)
  - name: file-log
    config:
      path: /tmp/kong-logs/access.log
      reopen: true

# HTTP Logging (Production - Send to centralized logging)
  # Uncomment and configure for production
  # - name: http-log
  #   config:
  #     http_endpoint: http://log-collector:9200/kong/logs
  #     method: POST
  #     content_type: application/json
  #     timeout: 10000
  #     keepalive: 60000

# =============================================================================
# PROMETHEUS PLUGIN (Metrics)
# =============================================================================

  - name: prometheus
    config:
      per_consumer: true

# =============================================================================
# RATE LIMITING PLUGINS (Service-Specific)
# =============================================================================

# Alert Ingestor - Higher rate limit for ingestion
  - name: rate-limiting
    route: alert-ingestor-ingest
    config:
      minute: 500              # 500 alerts per minute
      hour: 5000               # 5000 alerts per hour
      policy: redis
      redis_host: redis
      redis_port: 6379
      redis_password: ${REDIS_PASSWORD}
      redis_database: 2
      fault_tolerant: true

# AI Triage Agent - Lower rate limit (expensive operations)
  - name: rate-limiting
    route: ai-triage-analyze
    config:
      minute: 100              # 100 analyses per minute
      hour: 1000               # 1000 analyses per hour
      policy: redis
      redis_host: redis
      redis_port: 6379
      redis_password: ${REDIS_PASSWORD}
      redis_database: 3
      fault_tolerant: true

# =============================================================================
# JWT CREDENTIALS (Initial JWT Secrets)
# =============================================================================

consumers:
  # Admin User
  - username: admin
    custom_id: admin_user_001
    jwt_secrets:
      - consumer: admin
        key: admin-key-secret
        secret: admin-secret-key-change-me-in-production

  # Service Account (for inter-service communication)
  - username: service-account
    custom_id: service_account_001
    jwt_secrets:
      - consumer: service-account
        key: service-key-secret
        secret: service-secret-key-change-me-in-production

  # Viewer User (read-only access)
  - username: viewer
    custom_id: viewer_user_001
    jwt_secrets:
      - consumer: viewer
        key: viewer-key-secret
        secret: viewer-secret-key-change-me-in-production
    acls:
      - group: viewer

  # Operator User (can trigger workflows)
  - username: operator
    custom_id: operator_user_001
    jwt_secrets:
      - consumer: operator
        key: operator-key-secret
        secret: operator-secret-key-change-me-in-production
    acls:
      - group: operator

  # Admin User (full access)
  - username: admin
    custom_id: admin_user_001
    acls:
      - group: admin

# =============================================================================
# END OF CONFIGURATION
# =============================================================================

#
# Usage Instructions:
#
# 1. Start Kong with this configuration:
#    docker-compose up -d kong
#
# 2. Apply configuration:
#    docker cp kong.yml kong:/usr/local/kong/kong.yml
#    docker exec kong kong config db_import /usr/local/kong/kong.yml
#
# 3. Generate JWT token:
#    Use the JWT credentials above to generate tokens for testing
#
# 4. Access APIs:
#    curl -H "Authorization: Bearer <JWT_TOKEN>" http://localhost:8000/api/v1/alerts
#
# 5. View Kong metrics:
#    http://localhost:8001/metrics (Prometheus format)
#
# For more information, see:
# - https://docs.konghq.com/gateway/latest/deck/declarative/
# - https://docs.konghq.com/gateway/latest/plugin/jwt/
# - https://docs.konghq.com/gateway/latest/plugin/rate-limiting/
