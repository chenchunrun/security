# =============================================================================
# Security Triage System - Development Mode
# =============================================================================
# Lightweight configuration for local development
# Only starts core services + infrastructure
#
# Usage:
#   docker-compose -f docker-compose.dev.yml up -d
#   docker-compose -f docker-compose.dev.yml down
#
# =============================================================================

version: '3.8'

services:
  # =============================================================================
  # Infrastructure Services (Required)
  # =============================================================================

  # PostgreSQL 15 - Main Database
  postgres:
    image: postgres:15-alpine
    container_name: security-triage-postgres
    environment:
      POSTGRES_DB: security_triage
      POSTGRES_USER: triage_user
      POSTGRES_PASSWORD: ${DB_PASSWORD:-triage_password}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5434:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: pg_isready -U triage_user -d security_triage
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - security-triage-network

  # Redis 7 - Cache and Session Store
  redis:
    image: redis:7-alpine
    container_name: security-triage-redis
    command: redis-server --appendonly yes
    ports:
      - "6381:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: redis-cli ping
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - security-triage-network

  # RabbitMQ 3.12 - Message Queue
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: security-triage-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-rabbitmq_password}
      RABBITMQ_DEFAULT_VHOST: /
    ports:
      - "5673:5672"   # AMQP protocol
      - "15673:15672" # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 15s
    networks:
      - security-triage-network

  # ChromaDB - Vector Database
  chromadb:
    image: chromadb/chroma:latest
    container_name: security-triage-chromadb
    ports:
      - "8001:8000"
    volumes:
      - chroma_data:/chroma/chroma
    healthcheck:
      test: wget -q --spider http://localhost:8000/api/v1/heartbeat || exit 1
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - security-triage-network

  # =============================================================================
  # Core Processing Services (Dev Mode - Minimal)
  # =============================================================================

  # Alert Ingestor - Entry point for all alerts
  alert-ingestor:
    build:
      context: .
      dockerfile: services/alert_ingestor/Dockerfile
    container_name: security-triage-alert-ingestor
    environment:
      DATABASE_URL: postgresql+asyncpg://triage_user:${DB_PASSWORD:-triage_password}@postgres:5432/security_triage
      REDIS_URL: redis://@redis:6379/0
      RABBITMQ_URL: amqp://admin:${RABBITMQ_PASSWORD:-rabbitmq_password}@rabbitmq:5672/
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-dev-secret-key}
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "9001:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: wget -q --spider http://localhost:8000/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - security-triage-network

  # Alert Normalizer - Standardize alert formats
  alert-normalizer:
    build:
      context: .
      dockerfile: services/alert_normalizer/Dockerfile
    container_name: security-triage-alert-normalizer
    environment:
      DATABASE_URL: postgresql+asyncpg://triage_user:${DB_PASSWORD:-triage_password}@postgres:5432/security_triage
      REDIS_URL: redis://@redis:6379/0
      RABBITMQ_URL: amqp://admin:${RABBITMQ_PASSWORD:-rabbitmq_password}@rabbitmq:5672/
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-dev-secret-key}
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "9002:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      alert-ingestor:
        condition: service_healthy
    healthcheck:
      test: wget -q --spider http://localhost:8000/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - security-triage-network

  # Context Collector - Enrich alerts with context
  context-collector:
    build:
      context: .
      dockerfile: services/context_collector/Dockerfile
    container_name: security-triage-context-collector
    environment:
      DATABASE_URL: postgresql+asyncpg://triage_user:${DB_PASSWORD:-triage_password}@postgres:5432/security_triage
      REDIS_URL: redis://@redis:6379/0
      RABBITMQ_URL: amqp://admin:${RABBITMQ_PASSWORD:-rabbitmq_password}@rabbitmq:5672/
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-dev-secret-key}
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "9003:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      alert-normalizer:
        condition: service_healthy
    healthcheck:
      test: wget -q --spider http://localhost:8000/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    volumes:
      - ./logs:/app/logs
    networks:
      - security-triage-network

  # AI Triage Agent - Core analysis engine
  ai-triage-agent:
    build:
      context: .
      dockerfile: services/ai_triage_agent/Dockerfile
    container_name: security-triage-ai-triage-agent
    environment:
      DATABASE_URL: postgresql+asyncpg://triage_user:${DB_PASSWORD:-triage_password}@postgres:5432/security_triage
      REDIS_URL: redis://@redis:6379/0
      RABBITMQ_URL: amqp://admin:${RABBITMQ_PASSWORD:-rabbitmq_password}@rabbitmq:5672/
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-dev-secret-key}
      # LLM Configuration - Use env vars for real API
      LLM_API_KEY: ${LLM_API_KEY}
      LLM_BASE_URL: ${LLM_BASE_URL}
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "9006:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      context-collector:
        condition: service_healthy
    healthcheck:
      test: wget -q --spider http://localhost:8000/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - security-triage-network

  # =============================================================================
  # Web Dashboard
  # =============================================================================

  # Web Dashboard - React frontend
  web-dashboard:
    build:
      context: .
      dockerfile: services/web_dashboard/Dockerfile
    container_name: security-triage-web-dashboard
    environment:
      DATABASE_URL: postgresql+asyncpg://triage_user:${DB_PASSWORD:-triage_password}@postgres:5432/security_triage
      REDIS_URL: redis://@redis:6379/0
      RABBITMQ_URL: amqp://admin:${RABBITMQ_PASSWORD:-rabbitmq_password}@rabbitmq:5672/
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-dev-secret-key}
      API_BASE_URL: http://localhost:9001
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "3000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      ai-triage-agent:
        condition: service_healthy
    healthcheck:
      test: wget -q --spider http://localhost:8000/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - security-triage-network

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local
  chroma_data:
    driver: local

networks:
  security-triage-network:
    driver: bridge
